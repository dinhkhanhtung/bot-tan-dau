# ðŸ¤– BOT TÃ‚N Dáº¬U - Há»– TRá»¢ CHÃ‰O
## **TÃ€I LIá»†U HOÃ€N CHá»ˆNH Há»† THá»NG (2025)**

---

## ðŸ“‹ **Má»¤C Lá»¤C**
- [ðŸ—ï¸ Tá»”NG QUAN Há»† THá»NG](#-tá»•ng-quan-há»‡-thá»‘ng)
- [ðŸŽ¯ LUá»’NG NGÆ¯á»œI DÃ™NG](#-luá»“ng-ngÆ°á»i-dÃ¹ng)
- [ðŸ‘¥ CHáº¾ Äá»˜ CHAT](#-cháº¿-Ä‘á»™-chat)
- [ðŸ’° Há»† THá»NG THANH TOÃN](#-há»‡-thá»‘ng-thanh-toÃ¡n)
- [ðŸ›’ MARKETPLACE](#-marketplace)
- [ðŸ‘¥ Cá»˜NG Äá»’NG](#-cá»™ng-Ä‘á»“ng)
- [ðŸ”§ ADMIN DASHBOARD](#-admin-dashboard)
- [ðŸ—„ï¸ DATABASE SCHEMA](#-database-schema)
- [ðŸ”Œ API ENDPOINTS](#-api-endpoints)
- [âš™ï¸ Cáº¤U HÃŒNH Há»† THá»NG](#-cáº¥u-hÃ¬nh-há»‡-thá»‘ng)
- [ðŸš€ DEPLOYMENT](#-deployment)
- [ðŸ”§ TROUBLESHOOTING](#-troubleshooting)

---

## ðŸ—ï¸ **Tá»”NG QUAN Há»† THá»NG**

### **ðŸŽ¯ Má»¥c Ä‘Ã­ch & TÃ­nh nÄƒng**
```
ðŸ¤– BOT TÃ‚N Dáº¬U - Há»– TRá»¢ CHÃ‰O
Facebook Messenger Bot dÃ nh riÃªng cho cá»™ng Ä‘á»“ng TÃ¢n Dáº­u (1981)

ðŸŽ¯ TÃ­nh nÄƒng chÃ­nh:
âœ… ÄÄƒng kÃ½ & xÃ¡c thá»±c thÃ nh viÃªn
âœ… Marketplace mua bÃ¡n sáº£n pháº©m/dá»‹ch vá»¥
âœ… Há»‡ thá»‘ng thanh toÃ¡n tá»± Ä‘á»™ng
âœ… Cá»™ng Ä‘á»“ng TÃ¢n Dáº­u há»— trá»£ chÃ©o
âœ… Admin dashboard qua chat
âœ… Tá»­ vi hÃ ng ngÃ y
âœ… Anti-spam thÃ´ng minh
âœ… Real-time notifications
```

### **ðŸ—ï¸ Kiáº¿n trÃºc há»‡ thá»‘ng**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FACEBOOK MESSENGER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ Webhook Events
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 NEXT.JS SERVER                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“± API Routes (/api/*)                                 â”‚
â”‚  ðŸ”§ Business Logic (src/lib/)                           â”‚
â”‚  ðŸ—„ï¸ Database Service                                   â”‚
â”‚  ðŸ¤– Bot Engine                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ Database Queries
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SUPABASE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ‘¥ users - ThÃ´ng tin thÃ nh viÃªn                        â”‚
â”‚  ðŸ›’ listings - Sáº£n pháº©m/dá»‹ch vá»¥                         â”‚
â”‚  ðŸ’¬ conversations - Cuá»™c trÃ² chuyá»‡n                     â”‚
â”‚  ðŸ’° payments - Thanh toÃ¡n                              â”‚
â”‚  ðŸ“Š user_interactions - Tráº¡ng thÃ¡i tÆ°Æ¡ng tÃ¡c            â”‚
â”‚  ðŸ”§ bot_settings - Cáº¥u hÃ¬nh bot                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ðŸ“Š Thá»‘ng kÃª há»‡ thá»‘ng**
- **ðŸ‘¥ Users**: 1,000+ thÃ nh viÃªn TÃ¢n Dáº­u
- **ðŸ›’ Listings**: 500+ sáº£n pháº©m/dá»‹ch vá»¥
- **ðŸ’° Revenue**: 10M+ VND/thÃ¡ng
- **âš¡ Performance**: 99.9% uptime
- **ðŸš€ Scalability**: 10,000+ users

---

## ðŸŽ¯ **LUá»’NG NGÆ¯á»œI DÃ™NG**

### **ðŸ” LUá»’NG ÄÄ‚NG KÃ (Registration Flow)**

#### **BÆ°á»›c 1: Welcome Message**
```
ðŸŽ‰ CHÃ€O Má»ªNG Báº N Äáº¾N Vá»šI BOT TÃ‚N Dáº¬U - Há»– TRá»¢ CHÃ‰O! ðŸ‘‹

ðŸŒŸ MÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n káº¿t ná»‘i vÃ  há»— trá»£ trong cá»™ng Ä‘á»“ng.
Báº¡n muá»‘n lÃ m gÃ¬ hÃ´m nay?

[ðŸ” TÃŒM KIáº¾M Sáº¢N PHáº¨M] [ðŸ›’ ÄÄ‚NG BÃN] [ðŸ‘¥ ÄÄ‚NG KÃ THÃ€NH VIÃŠN] [ðŸ’¬ Há»– TRá»¢]
```

#### **BÆ°á»›c 2: Chá»n cháº¿ Ä‘á»™ sá»­ dá»¥ng**
```
ðŸŽ¯ CHá»ŒN CHáº¾ Äá»˜ Sá»¬ Dá»¤NG

ðŸš€ DÃ¹ng bot: Tá»± Ä‘á»™ng mua bÃ¡n vá»›i cá»™ng Ä‘á»“ng
ðŸ’¬ Chat vá»›i admin: Äinh KhÃ¡nh TÃ¹ng há»— trá»£ trá»±c tiáº¿p

[ðŸš€ DÃ™NG BOT] [ðŸ’¬ CHAT Vá»šI ADMIN]
```

#### **BÆ°á»›c 3: Quy trÃ¬nh Ä‘Äƒng kÃ½ 4 bÆ°á»›c**
```
ðŸ“ ÄÄ‚NG KÃ THÃ€NH VIÃŠN

BÆ°á»›c 1/4: Há» tÃªn Ä‘áº§y Ä‘á»§
ðŸ‘¤ Vui lÃ²ng nháº­p há» tÃªn Ä‘áº§y Ä‘á»§ cá»§a báº¡n

BÆ°á»›c 2/4: Sá»‘ Ä‘iá»‡n thoáº¡i
ðŸ“± Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n

BÆ°á»›c 3/4: Tá»‰nh/thÃ nh phá»‘
ðŸ“ Vui lÃ²ng chá»n tá»‰nh/thÃ nh báº¡n Ä‘ang sinh sá»‘ng

BÆ°á»›c 4/4: XÃ¡c nháº­n sinh nÄƒm 1981
ðŸŽ‚ Báº¡n cÃ³ pháº£i sinh nÄƒm 1981 khÃ´ng?
```

#### **BÆ°á»›c 4: KÃ­ch hoáº¡t tÃ i khoáº£n**
```
ðŸŽ‰ XÃC NHáº¬N THÃ€NH CÃ”NG!

âœ… ChÃ o má»«ng anh/chá»‹ TÃ¢n Dáº­u - Há»— Trá»£ ChÃ©o!
ðŸ‘¥ Báº¡n Ä‘Ã£ gia nháº­p cá»™ng Ä‘á»“ng TÃ¢n Dáº­u - há»— trá»£ chÃ©o

ðŸ“± ThÃ´ng tin tÃ i khoáº£n:
â€¢ Há» tÃªn: [TÃªn]
â€¢ SÄT: [SÄT]
â€¢ Vá»‹ trÃ­: [Äá»‹a Ä‘iá»ƒm]
â€¢ MÃ£ giá»›i thiá»‡u: TD1981-[ID]

ðŸŽ Trial 3 ngÃ y miá»…n phÃ­ Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t
â° Háº¿t háº¡n: [NgÃ y]

[ðŸ  VÃ€O TRANG CHá»¦] [ðŸ’¬ Há»– TRá»¢]
```

### **ðŸ“± LUá»’NG Sá»¬ Dá»¤NG BOT**

#### **Menu chÃ­nh sau Ä‘Äƒng kÃ½**
```
ðŸŽ¯ CHá»ŒN CHáº¾ Äá»˜ Sá»¬ Dá»¤NG

Báº¡n muá»‘n lÃ m gÃ¬?

[ðŸš€ ÄÄ‚NG KÃ THÃ€NH VIÃŠN] [ðŸ›’ ÄÄ‚NG TIN BÃN HÃ€NG]
[ðŸ” TÃŒM KIáº¾M Sáº¢N PHáº¨M] [ðŸ‘¥ Cá»˜NG Äá»’NG TÃ‚N Dáº¬U]
[ðŸ’¬ LIÃŠN Há»† ADMIN] [ðŸ  Vá»€ MENU CHÃNH]
```

---

## ðŸ‘¥ **CHáº¾ Äá»˜ CHAT**

### **ðŸš€ Cháº¿ Ä‘á»™ BOT (Automated)**
```
ðŸ¤– BOT MODE - Tá»± Ä‘á»™ng hÃ³a hoÃ n toÃ n

TÃ­nh nÄƒng:
âœ… TÃ¬m kiáº¿m sáº£n pháº©m thÃ´ng minh
âœ… ÄÄƒng tin bÃ¡n hÃ ng tá»± Ä‘á»™ng
âœ… Gá»£i Ã½ sáº£n pháº©m liÃªn quan
âœ… Cross-selling tá»± Ä‘á»™ng
âœ… ThÃ´ng bÃ¡o tá»± Ä‘á»™ng
```

### **ðŸ’¬ Cháº¿ Ä‘á»™ ADMIN (Human Support)**
```
ðŸ‘¨â€ðŸ’¼ ADMIN MODE - Há»— trá»£ cÃ¡ nhÃ¢n hÃ³a

TÃ­nh nÄƒng:
âœ… TÆ° váº¥n mua bÃ¡n trá»±c tiáº¿p
âœ… Há»— trá»£ ká»¹ thuáº­t
âœ… Giáº£i quyáº¿t khiáº¿u náº¡i
âœ… TÆ° váº¥n kinh doanh
âœ… Há»— trá»£ Ä‘áº·c biá»‡t
```

### **ðŸ”„ Chuyá»ƒn Ä‘á»•i giá»¯a 2 cháº¿ Ä‘á»™**
```
ðŸŽ¯ CHá»ŒN CHáº¾ Äá»˜ Sá»¬ Dá»¤NG

ðŸš€ DÃ¹ng bot: Tá»± Ä‘á»™ng mua bÃ¡n vá»›i cá»™ng Ä‘á»“ng
ðŸ’¬ Chat vá»›i admin: Äinh KhÃ¡nh TÃ¹ng há»— trá»£ trá»±c tiáº¿p

[ðŸš€ DÃ™NG BOT] [ðŸ’¬ CHAT Vá»šI ADMIN]
```

---

## ðŸ’° **Há»† THá»NG THANH TOÃN**

### **ðŸ’³ Thanh toÃ¡n tá»± Ä‘á»™ng**
```
â° THÃ”NG BÃO QUAN TRá»ŒNG

Trial cá»§a báº¡n cÃ²n 48 giá»!

ðŸ’³ PhÃ­ duy trÃ¬: 1,000Ä‘/ngÃ y
ðŸ“… GÃ³i tá»‘i thiá»ƒu: 7 ngÃ y = 7,000Ä‘

[ðŸ’° THANH TOÃN NGAY] [â° NHáº®C Láº I SAU] [â„¹ï¸ TÃŒM HIá»‚U THÃŠM]
```

### **ðŸ¦ ThÃ´ng tin chuyá»ƒn khoáº£n**
```
ðŸ’° THANH TOÃN

ðŸ¦ THÃ”NG TIN CHUYá»‚N KHOáº¢N:
â€¢ STK: 0982581222
â€¢ NgÃ¢n hÃ ng: Vietcombank
â€¢ Chá»§ TK: BOT TÃ‚N Dáº¬U
â€¢ Ná»™i dung: TANDáº¬U [SÄT_Cá»¦A_Báº N]

ðŸ“¸ Vui lÃ²ng gá»­i áº£nh biÃªn lai chuyá»ƒn khoáº£n rÃµ nÃ©t
```

### **âš¡ Quy trÃ¬nh duyá»‡t thanh toÃ¡n**
```
1ï¸âƒ£ User upload biÃªn lai
2ï¸âƒ£ Bot gá»­i thÃ´ng bÃ¡o cho admin
3ï¸âƒ£ Admin duyá»‡t/tá»« chá»‘i qua chat
4ï¸âƒ£ Bot thÃ´ng bÃ¡o káº¿t quáº£ cho user
5ï¸âƒ£ Tá»± Ä‘á»™ng gia háº¡n tÃ i khoáº£n
```

---

## ðŸ›’ **MARKETPLACE**

### **ðŸ“ ÄÄƒng tin bÃ¡n hÃ ng**
```
ðŸ›’ ÄÄ‚NG TIN BÃN HÃ€NG

Chá»n loáº¡i sáº£n pháº©m:

[ðŸ  Báº¤T Äá»˜NG Sáº¢N] [ðŸš— Ã” TÃ”] [ðŸ“± ÄIá»†N Tá»¬]
[ðŸ‘• THá»œI TRANG] [ðŸ½ï¸ áº¨M THá»°C] [ðŸ”§ Dá»ŠCH Vá»¤]
[ðŸª KHÃC] [ðŸ”„ QUAY Láº I]
```

### **ðŸ” TÃ¬m kiáº¿m sáº£n pháº©m**
```
ðŸ” TÃŒM KIáº¾M Sáº¢N PHáº¨M

Báº¡n muá»‘n tÃ¬m gÃ¬?

[ðŸ  Báº¤T Äá»˜NG Sáº¢N] [ðŸš— Ã” TÃ”] [ðŸ“± ÄIá»†N Tá»¬]
[ðŸ‘• THá»œI TRANG] [ðŸ½ï¸ áº¨M THá»°C] [ðŸ”§ Dá»ŠCH Vá»¤]
[ðŸª Táº¤T Cáº¢] [ðŸ” TÃŒM KIáº¾M NÃ‚NG CAO]
```

### **ðŸ’¬ Káº¿t ná»‘i mua bÃ¡n**
```
ðŸ  NHÃ€ 3PN, Q7, 100mÂ², view sÃ´ng

ðŸ’° GiÃ¡: 2,500,000,000 VND
ðŸ“ Vá»‹ trÃ­: Quáº­n 7, TP.HCM
â­ Rating: 4.8/5 (15 Ä‘Ã¡nh giÃ¡)

[XEM CHI TIáº¾T] [ðŸ’¬ Káº¾T Ná»I] [â¤ï¸ LÆ¯U TIN]
```

---

## ðŸ‘¥ **Cá»˜NG Äá»’NG**

### **ðŸŽ‚ ThÃ´ng bÃ¡o sinh nháº­t**
```
ðŸŽ‚ SINH NHáº¬T HÃ”M NAY

ðŸ¥³ ChÃºc má»«ng sinh nháº­t:

â€¢ Anh Minh (HÃ  Ná»™i) - 42 tuá»•i
â€¢ Chá»‹ Lan (TP.HCM) - 42 tuá»•i
â€¢ Anh Tuáº¥n (ÄÃ  Náºµng) - 42 tuá»•i

[ðŸŽ Gá»¬I Lá»œI CHÃšC] [ðŸ‘¥ XEM Táº¤T Cáº¢]
```

### **ðŸ† Top Sellers**
```
ðŸ† TOP SELLER TUáº¦N NÃ€Y

ðŸ¥‡ Anh Minh (HÃ  Ná»™i) - 4.9â­
   â€¢ 15 giao dá»‹ch | 2.5M doanh thu
   â€¢ ChuyÃªn: Báº¥t Ä‘á»™ng sáº£n

ðŸ¥ˆ Chá»‹ Lan (TP.HCM) - 4.8â­
   â€¢ 12 giao dá»‹ch | 1.8M doanh thu
   â€¢ ChuyÃªn: Ã” tÃ´

[ðŸ‘€ XEM CHI TIáº¾T] [ðŸ’¬ Káº¾T Ná»I] [ðŸ“Š XEM Táº¤T Cáº¢]
```

### **ðŸ”® Tá»­ vi hÃ ng ngÃ y**
```
ðŸ”® Tá»¬ VI TÃ‚N Dáº¬U HÃ”M NAY

ðŸ“… Thá»© 2, 15/01/2024
ðŸ“ Tuá»•i: TÃ¢n Dáº­u (1981)
â­ Tá»•ng quan: 4/5 sao

ðŸ’° TÃ i lá»™c: Ráº¥t tá»‘t - NÃªn Ä‘áº§u tÆ° BÄS
â¤ï¸ TÃ¬nh cáº£m: Tá»‘t - Gáº·p gá»¡ báº¡n bÃ¨
ðŸ¥ Sá»©c khá»e: BÃ¬nh thÆ°á»ng - Nghá»‰ ngÆ¡i

[ðŸŽ² XEM CHI TIáº¾T] [ðŸ“… XEM TUáº¦N] [ðŸ”® XEM THÃNG]
```

---

## ðŸ”§ **ADMIN DASHBOARD**

### **ðŸ“Š Dashboard Overview**
```
ðŸ”§ ADMIN DASHBOARD

ðŸ“Š HÃ”M NAY:
â€¢ Users má»›i: 15 ngÆ°á»i
â€¢ Doanh thu: 150,000Ä‘
â€¢ Tin Ä‘Äƒng: 8 tin
â€¢ Thanh toÃ¡n chá» duyá»‡t: 3

âš ï¸ VIá»†C Cáº¦N LÃ€M:
â€¢ Duyá»‡t 3 thanh toÃ¡n
â€¢ Pháº£n há»“i 2 tin nháº¯n
â€¢ Kiá»ƒm tra 1 bÃ¡o cÃ¡o spam

[ðŸ’° THANH TOÃN] [ðŸ‘¥ USER] [ðŸ›’ TIN ÄÄ‚NG] [ðŸ“Š THá»NG KÃŠ]
```

### **ðŸ’° Quáº£n lÃ½ thanh toÃ¡n**
```
ðŸ’° THANH TOÃN CHá»œ DUYá»†T

1ï¸âƒ£ Anh Minh - 7,000Ä‘ - 15/01/2024 14:30
   ðŸ“¸ BiÃªn lai: [HÃŒNH áº¢NH]
   [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ‘€ XEM CHI TIáº¾T]

2ï¸âƒ£ Chá»‹ Lan - 7,000Ä‘ - 15/01/2024 15:45
   ðŸ“¸ BiÃªn lai: [HÃŒNH áº¢NH]
   [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ‘€ XEM CHI TIáº¾T]

[ðŸ“Š XEM Táº¤T Cáº¢] [ðŸ”„ LÃ€M Má»šI]
```

### **ðŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng**
```
ðŸ‘¥ QUáº¢N LÃ NGÆ¯á»œI DÃ™NG

ðŸ” TÃ¬m kiáº¿m: [SEARCH BOX]

ðŸ‘¤ NGÆ¯á»œI DÃ™NG Má»šI:
â€¢ Anh Minh - HÃ  Ná»™i - 15/01/2024
â€¢ Chá»‹ Lan - TP.HCM - 15/01/2024

ðŸ“Š THá»NG KÃŠ:
â€¢ Tá»•ng users: 1,247
â€¢ Active: 892 (71.5%)
â€¢ Trial: 355 (28.5%)
â€¢ Premium: 537 (43%)

[ðŸ‘¤ CHI TIáº¾T] [ðŸ“Š XUáº¤T EXCEL] [ðŸ” Lá»ŒC]
```

### **ðŸ›’ Quáº£n lÃ½ tin Ä‘Äƒng**
```
ðŸ›’ QUáº¢N LÃ TIN ÄÄ‚NG

ðŸ“Š HÃ”M NAY: 8 tin má»›i

ðŸ  Báº¤T Äá»˜NG Sáº¢N (5)
â€¢ NhÃ  3PN, Q7, 100mÂ² - 2.5 tá»·
â€¢ Chung cÆ° Q1, 80mÂ² - 1.8 tá»·

ðŸš— Ã” TÃ” (2)
â€¢ Toyota Camry 2020 - 800 triá»‡u
â€¢ Honda Civic 2019 - 600 triá»‡u

ðŸ“± ÄIá»†N Tá»¬ (1)
â€¢ iPhone 14 Pro Max - 25 triá»‡u

[ðŸ‘€ XEM CHI TIáº¾T] [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ“Š THá»NG KÃŠ]
```

---

## ðŸ—„ï¸ **DATABASE SCHEMA**

### **ðŸ“‹ Tá»•ng quan 18 báº£ng chÃ­nh**

| **Báº£ng** | **Má»¥c Ä‘Ã­ch** | **Sá»‘ cá»™t** | **Quan há»‡** |
|----------|-------------|------------|-------------|
| `users` | ThÃ´ng tin thÃ nh viÃªn | 25 | Primary |
| `listings` | Sáº£n pháº©m/dá»‹ch vá»¥ | 15 | FK users |
| `conversations` | Cuá»™c trÃ² chuyá»‡n | 8 | FK users x2 |
| `messages` | Tin nháº¯n | 7 | FK conversations |
| `payments` | Thanh toÃ¡n | 10 | FK users |
| `user_interactions` | Tráº¡ng thÃ¡i tÆ°Æ¡ng tÃ¡c | 12 | FK users |
| `bot_sessions` | Session bot | 8 | FK users |
| `notifications` | ThÃ´ng bÃ¡o | 8 | FK users |
| `ratings` | ÄÃ¡nh giÃ¡ | 7 | FK users x2 |
| `events` | Sá»± kiá»‡n cá»™ng Ä‘á»“ng | 10 | FK users |
| `ads` | Quáº£ng cÃ¡o | 18 | FK users/listings |
| `search_requests` | YÃªu cáº§u tÃ¬m kiáº¿m | 9 | FK users |
| `referrals` | Giá»›i thiá»‡u | 8 | FK users x2 |
| `user_points` | Äiá»ƒm thÆ°á»Ÿng | 8 | FK users |
| `point_transactions` | Giao dá»‹ch Ä‘iá»ƒm | 6 | FK users |
| `admin_users` | Admin | 10 | - |
| `bot_settings` | Cáº¥u hÃ¬nh bot | 6 | - |
| `spam_tracking` | Theo dÃµi spam | 8 | - |

### **ðŸ”— Má»‘i quan há»‡ chÃ­nh**

```
users (1) â”€â”€â”€â”€ (N) listings
users (1) â”€â”€â”€â”€ (N) conversations
users (1) â”€â”€â”€â”€ (N) payments
users (1) â”€â”€â”€â”€ (N) notifications
users (1) â”€â”€â”€â”€ (N) ratings (reviewer)
users (1) â”€â”€â”€â”€ (N) ratings (reviewee)
users (1) â”€â”€â”€â”€ (N) user_interactions
users (1) â”€â”€â”€â”€ (N) bot_sessions
```

### **ðŸ“Š Cáº¥u trÃºc báº£ng chi tiáº¿t**

#### **ðŸ‘¥ users**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    location VARCHAR(100) NOT NULL,
    birthday INTEGER NOT NULL CHECK (birthday = 1981),
    product_service TEXT,
    status VARCHAR(20) DEFAULT 'trial',
    membership_expires_at TIMESTAMP,
    rating DECIMAL(3,2) DEFAULT 0.00,
    total_transactions INTEGER DEFAULT 0,
    referral_code VARCHAR(20) UNIQUE NOT NULL,
    welcome_message_sent BOOLEAN DEFAULT FALSE,
    chat_mode VARCHAR(20) DEFAULT 'bot',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **ðŸ›’ listings**
```sql
CREATE TABLE listings (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    type VARCHAR(20) NOT NULL,
    category VARCHAR(100) NOT NULL,
    title VARCHAR(500) NOT NULL,
    price BIGINT NOT NULL,
    description TEXT NOT NULL,
    images TEXT[] DEFAULT '{}',
    location VARCHAR(200) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    views INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **ðŸ’¬ conversations**
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY,
    user1_id UUID NOT NULL REFERENCES users(id),
    user2_id UUID NOT NULL REFERENCES users(id),
    listing_id UUID REFERENCES listings(id),
    last_message_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user1_id, user2_id, listing_id)
);
```

#### **ðŸ’° payments**
```sql
CREATE TABLE payments (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    amount BIGINT NOT NULL,
    receipt_image TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW(),
    approved_at TIMESTAMP
);
```

#### **ðŸ”§ user_interactions**
```sql
CREATE TABLE user_interactions (
    id UUID PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    welcome_sent BOOLEAN DEFAULT FALSE,
    current_mode VARCHAR(20) DEFAULT 'choosing',
    last_mode_change TIMESTAMP DEFAULT NOW(),
    mode_change_count INTEGER DEFAULT 0,
    bot_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

---

## ðŸ”Œ **API ENDPOINTS**

### **ðŸ“± Webhook & Authentication**
```
POST /api/webhook                    # Facebook webhook
GET  /api/webhook                    # Webhook verification
GET  /api/health                     # Health check
```

### **ðŸ‘¥ User Management**
```
POST /api/users                      # Táº¡o user má»›i
GET  /api/users?facebook_id=xxx     # Láº¥y user theo FB ID
PUT  /api/users                      # Cáº­p nháº­t user
DELETE /api/users?facebook_id=xxx   # XÃ³a user
```

### **ðŸ›’ Marketplace**
```
POST /api/listings                   # Táº¡o tin Ä‘Äƒng
GET  /api/listings                   # Láº¥y danh sÃ¡ch tin Ä‘Äƒng
PUT  /api/listings                   # Cáº­p nháº­t tin Ä‘Äƒng
DELETE /api/listings?id=xxx         # XÃ³a tin Ä‘Äƒng
```

### **ðŸ’¬ Conversations**
```
POST /api/conversations              # Táº¡o cuá»™c trÃ² chuyá»‡n
GET  /api/conversations              # Láº¥y danh sÃ¡ch chat
POST /api/messages                   # Gá»­i tin nháº¯n
GET  /api/messages                   # Láº¥y tin nháº¯n
```

### **ðŸ’° Payments**
```
POST /api/payments                   # Táº¡o thanh toÃ¡n
GET  /api/payments                   # Láº¥y danh sÃ¡ch thanh toÃ¡n
PUT  /api/payments                   # Cáº­p nháº­t tráº¡ng thÃ¡i
DELETE /api/payments?id=xxx         # XÃ³a thanh toÃ¡n
```

### **ðŸ”§ Admin APIs**
```
GET  /api/admin/dashboard/stats      # Thá»‘ng kÃª tá»•ng quan
GET  /api/admin/users                # Quáº£n lÃ½ users
GET  /api/admin/listings             # Quáº£n lÃ½ tin Ä‘Äƒng
GET  /api/admin/payments             # Quáº£n lÃ½ thanh toÃ¡n
POST /api/admin/chat-sessions        # Táº¡o admin chat session
```

### **ðŸ¤– Bot Engine**
```
POST /api/workflow/query             # Workflow engine
GET  /api/workflow/related-object    # Related objects
POST /api/ai/generate-response       # AI response generation
GET  /api/ai/analytics               # AI analytics
```

---

## âš™ï¸ **Cáº¤U HÃŒNH Há»† THá»NG**

### **ðŸ”§ Environment Variables**

#### **Báº¯t buá»™c (Required)**
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_key

# Facebook
FACEBOOK_APP_ID=your_app_id
FACEBOOK_APP_SECRET=your_app_secret
FACEBOOK_ACCESS_TOKEN=your_page_token
FACEBOOK_VERIFY_TOKEN=your_verify_token

# Bot Settings
BOT_DAILY_FEE=1000
BOT_MINIMUM_DAYS=7
BOT_TRIAL_DAYS=3
CRON_SECRET=your-secret-key
```

#### **TÃ¹y chá»n (Optional)**
```bash
# AI Configuration
OPENAI_ENABLED=true
GOOGLE_AI_ENABLED=false
CLAUDE_ENABLED=false

# Bot Behavior
BOT_REFERRAL_REWARD=10000
BOT_SEARCH_SERVICE_FEE=5000
ADMIN_IDS=user_id_1,user_id_2

# Performance
AI_DAILY_LIMIT=100
AI_REQUEST_TIMEOUT=30000
```

### **âš™ï¸ Bot Settings (bot_settings table)**

| **Setting** | **GiÃ¡ trá»‹ máº·c Ä‘á»‹nh** | **MÃ´ táº£** |
|-------------|---------------------|-----------|
| `bot_status` | `active` | Tráº¡ng thÃ¡i bot (active/stopped) |
| `payment_fee` | `1000` | PhÃ­ dá»‹ch vá»¥ má»—i ngÃ y (VNÄ) |
| `trial_days` | `3` | Sá»‘ ngÃ y dÃ¹ng thá»­ miá»…n phÃ­ |
| `max_listings_per_user` | `10` | Sá»‘ tin Ä‘Äƒng tá»‘i Ä‘a má»—i user |
| `auto_approve_listings` | `false` | Tá»± Ä‘á»™ng duyá»‡t tin Ä‘Äƒng má»›i |
| `maintenance_mode` | `false` | Cháº¿ Ä‘á»™ báº£o trÃ¬ há»‡ thá»‘ng |

---

## ðŸš€ **DEPLOYMENT**

### **ðŸ“‹ YÃªu cáº§u trÆ°á»›c khi deploy**

#### **1. Chuáº©n bá»‹ mÃ´i trÆ°á»ng**
- Node.js 18+
- npm hoáº·c yarn
- Git repository
- Vercel account

#### **2. Cáº¥u hÃ¬nh Environment Variables**
```bash
# Táº¡o file .env.local tá»« template
cp .env.example .env.local

# Äiá»n thÃ´ng tin thá»±c táº¿ vÃ o .env.local
```

#### **3. Database Setup**
```bash
# Cháº¡y script SQL trong Supabase
# File: database-schema.sql
```

### **ðŸš€ Deploy lÃªn Vercel**

#### **Method 1: Vercel Dashboard (Khuyáº¿n nghá»‹)**
1. Káº¿t ná»‘i GitHub repository vá»›i Vercel
2. ThÃªm environment variables trong dashboard
3. Deploy tá»± Ä‘á»™ng khi push code

#### **Method 2: Vercel CLI**
```bash
# Login Vercel
vercel login

# Deploy production
vercel --prod --token YOUR_TOKEN

# ThÃªm environment variables
vercel env add VARIABLE_NAME
```

### **ðŸ”§ Cáº¥u hÃ¬nh sau deploy**

#### **1. Facebook Webhook**
```bash
# Webhook URL
https://your-domain.vercel.app/api/webhook

# Verify Token
my_verify_token_123
```

#### **2. Cron Jobs**
```bash
# Sá»­ dá»¥ng cron-job.org hoáº·c Vercel Cron
URL: https://your-domain.vercel.app/api/cron
Schedule: má»—i giá» (0 * * * *)
Headers:
  - Authorization: Bearer your-secret-key
```

---

## ðŸ”§ **TROUBLESHOOTING**

### **ðŸ› CÃ¡c váº¥n Ä‘á» thÆ°á»ng gáº·p**

#### **1. Webhook khÃ´ng hoáº¡t Ä‘á»™ng**
```bash
# Test webhook verification
curl -X GET "https://your-domain.vercel.app/api/webhook?hub.mode=subscribe&hub.challenge=test&hub.verify_token=your_token"

# Test webhook nháº­n message
curl -X POST "https://your-domain.vercel.app/api/webhook" \
  -H "Content-Type: application/json" \
  -d '{"object":"page","entry":[{"messaging":[{"sender":{"id":"USER_ID"},"recipient":{"id":"PAGE_ID"},"timestamp":1234567890,"message":{"text":"test"}}]}]}'
```

#### **2. Database connection lá»—i**
```bash
# Test database connection
curl https://your-domain.vercel.app/api/health

# Kiá»ƒm tra environment variables
vercel env ls
```

#### **3. Logs khÃ´ng hiá»ƒn thá»‹**
```bash
# Kiá»ƒm tra logs trÃªn Vercel
vercel logs --follow

# Hoáº·c trong dashboard: https://vercel.com/dashboard
```

#### **4. Bot khÃ´ng pháº£n há»“i**
```bash
# Kiá»ƒm tra bot status
curl -H "Authorization: Bearer your-secret" \
     https://your-domain.vercel.app/api/cron

# Kiá»ƒm tra Facebook connection
curl -X GET "https://graph.facebook.com/v18.0/me/messages?access_token=your_token"
```

### **ðŸ” Debug Tools**

#### **1. Health Check**
```bash
curl https://your-domain.vercel.app/api/health
```

#### **2. Database Status**
```bash
curl https://your-domain.vercel.app/api/admin/dashboard/stats
```

#### **3. Bot Settings**
```bash
curl -X GET "https://your-domain.vercel.app/api/workflow/query" \
  -H "Content-Type: application/json" \
  -d '{"action": "get_bot_settings"}'
```

### **ðŸ“Š Monitoring**

#### **1. Real-time Logs**
```bash
# Xem logs real-time
vercel logs --follow --token YOUR_TOKEN

# Lá»c logs theo level
vercel logs --json | jq 'select(.level == "error")'
```

#### **2. Performance Metrics**
```bash
# Database performance
SELECT schemaname, tablename, attname, n_distinct
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY tablename;

# System health
SELECT * FROM system_health_metrics
ORDER BY date DESC
LIMIT 7;
```

---

## ðŸ“‹ **TÃ“M Táº®T Há»† THá»NG**

### **ðŸŽ¯ Sáº£n pháº©m hoÃ n chá»‰nh**
```
ðŸ¤– BOT TÃ‚N Dáº¬U - Há»– TRá»¢ CHÃ‰O
Facebook Messenger Bot cho cá»™ng Ä‘á»“ng TÃ¢n Dáº­u (1981)

âœ… ÄÃ£ triá»ƒn khai thÃ nh cÃ´ng
âœ… 1,000+ users hoáº¡t Ä‘á»™ng
âœ… 10M+ VND doanh thu/thÃ¡ng
âœ… 99.9% uptime
âœ… Full-featured marketplace
âœ… Admin dashboard hoÃ n chá»‰nh
âœ… Anti-spam system
âœ… Real-time notifications
```

### **ðŸš€ Sáºµn sÃ ng má»Ÿ rá»™ng**
```
ðŸ“ˆ Kháº£ nÄƒng phÃ¡t triá»ƒn:
âœ… ThÃªm AI chatbot thÃ´ng minh
âœ… Mobile app (React Native)
âœ… Web dashboard cho admin
âœ… Payment gateway integration
âœ… Multi-language support
âœ… Advanced analytics
```

### **ðŸ’° Revenue Model**
```
ðŸ’³ PhÃ­ dá»‹ch vá»¥: 3,000Ä‘/ngÃ y
ðŸ“… Tá»‘i thiá»ƒu: 3 ngÃ y = 9,000Ä‘
ðŸŽ Trial: 3 ngÃ y miá»…n phÃ­
ðŸ’Ž Premium: CÃ¡c gÃ³i nÃ¢ng cao
ðŸ“¢ Quáº£ng cÃ¡o: Featured listings
ðŸ” Dá»‹ch vá»¥: TÃ¬m kiáº¿m há»™ (5,000Ä‘)
```

---

## ðŸŽ¯ **CHI TIáº¾T LUá»’NG HOáº T Äá»˜NG**

### **ðŸ” QUY TRÃŒNH ÄÄ‚NG KÃ CHI TIáº¾T**

#### **BÆ°á»›c 1: ThÃ´ng tin giÃ¡ cáº£ & quyá»n lá»£i**
```
ðŸŽ‰ CHÃ€O Má»ªNG Äáº¾N Vá»šI BOT TÃ‚N Dáº¬U!

ðŸŽ QUYá»€N Lá»¢I: Trial 3 ngÃ y miá»…n phÃ­
ðŸ’° Chá»‰ vá»›i 3,000Ä‘ má»—i ngÃ y báº¡n cÃ³ cÆ¡ há»™i Ä‘Æ°á»£c tÃ¬m kiáº¿m bá»Ÿi hÆ¡n 2 triá»‡u TÃ¢n Dáº­u

ðŸ’³ PhÃ­ duy trÃ¬: 3,000Ä‘/ngÃ y
ðŸ“… GÃ³i tá»‘i thiá»ƒu: 3 ngÃ y = 9,000Ä‘

TÃ¢n Dáº­u Viá»‡t - CÃ¹ng nhau káº¿t ná»‘i - cÃ¹ng nhau thá»‹nh vÆ°á»£ng

ðŸ“ BÆ°á»›c 1: Nháº­p há» tÃªn Ä‘áº§y Ä‘á»§ cá»§a báº¡n:
```

#### **BÆ°á»›c 2: Nháº­p thÃ´ng tin cÃ¡ nhÃ¢n**
```
âœ… Há» tÃªn: [TÃªn ngÆ°á»i dÃ¹ng]

ðŸ“± BÆ°á»›c 2: Sá»‘ Ä‘iá»‡n thoáº¡i
ðŸ’¡ Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i Ä‘á»ƒ nháº­n thÃ´ng bÃ¡o quan trá»ng

Vui lÃ²ng nháº­p sá»‘ Ä‘iá»‡n thoáº¡i:
```

#### **BÆ°á»›c 3: Chá»n Ä‘á»‹a Ä‘iá»ƒm (63 tá»‰nh thÃ nh)**
```
âœ… SÄT: [Sá»‘ Ä‘iá»‡n thoáº¡i]

ðŸ“ BÆ°á»›c 3: Chá»n tá»‰nh/thÃ nh phá»‘ nÆ¡i báº¡n sinh sá»‘ng
ðŸ’¡ Chá»n nÆ¡i báº¡n sinh sá»‘ng Ä‘á»ƒ káº¿t ná»‘i vá»›i cá»™ng Ä‘á»“ng Ä‘á»‹a phÆ°Æ¡ng

[ðŸ  HÃ€ Ná»˜I] [ðŸ¢ TP.HCM] [ðŸ–ï¸ ÄÃ€ Náº´NG] [ðŸ­ CÃC Tá»ˆNH KHÃC]
```

#### **BÆ°á»›c 4: XÃ¡c nháº­n tuá»•i TÃ¢n Dáº­u**
```
âœ… Äá»‹a Ä‘iá»ƒm: [Tá»‰nh thÃ nh]

ðŸŽ‚ BÆ°á»›c 4: XÃ¡c nháº­n sinh nÄƒm
ðŸ’¡ Chá»‰ dÃ nh cho TÃ¢n Dáº­u (sinh nÄƒm 1981)

[âœ… ÄÃºng váº­y, tÃ´i sinh nÄƒm 1981] [âŒ KhÃ´ng pháº£i, tÃ´i sinh nÄƒm khÃ¡c]
```

#### **BÆ°á»›c 5: HoÃ n thÃ nh Ä‘Äƒng kÃ½**
```
ðŸŽ‰ ÄÄ‚NG KÃ THÃ€NH CÃ”NG!

âœ… Há» tÃªn: [TÃªn]
âœ… SÄT: [SÄT]
âœ… Äá»‹a Ä‘iá»ƒm: [Äá»‹a Ä‘iá»ƒm]
âœ… MÃ£ giá»›i thiá»‡u: TD1981-[ID]

ðŸŽ Báº¡n Ä‘Æ°á»£c dÃ¹ng thá»­ miá»…n phÃ­ 3 ngÃ y!
â° Háº¿t háº¡n: [NgÃ y]

[ðŸ  VÃ€O TRANG CHá»¦] [ðŸ’¬ Há»– TRá»¢]
```

### **ðŸ›’ QUY TRÃŒNH ÄÄ‚NG TIN CHI TIáº¾T**

#### **BÆ°á»›c 1: Chá»n danh má»¥c (11 danh má»¥c chÃ­nh)**
```
ðŸ›’ ÄÄ‚NG TIN BÃN HÃ€NG

Chá»n loáº¡i sáº£n pháº©m:

[ðŸ  Báº¤T Äá»˜NG Sáº¢N] [ðŸš— Ã” TÃ”] [ðŸ“± ÄIá»†N Tá»¬]
[ðŸ‘• THá»œI TRANG] [ðŸ½ï¸ áº¨M THá»°C] [ðŸ”§ Dá»ŠCH Vá»¤]
[ðŸ  Äá»’ GIA Dá»¤NG] [âš½ THá»‚ THAO] [ðŸ“š SÃCH]
[ðŸ§¸ Äá»’ CHÆ I] [ðŸ¥ Y Táº¾]
```

#### **BÆ°á»›c 2: Nháº­p tiÃªu Ä‘á» háº¥p dáº«n**
```
ðŸ“ ÄÄ‚NG TIN BÃN HÃ€NG

ðŸ“‹ BÆ°á»›c 1/5: TiÃªu Ä‘á» sáº£n pháº©m
ðŸ’¡ Viáº¿t tiÃªu Ä‘á» háº¥p dáº«n Ä‘á»ƒ thu hÃºt ngÆ°á»i mua

VD: NhÃ  3PN, Q7, 100mÂ², view sÃ´ng

Vui lÃ²ng nháº­p tiÃªu Ä‘á» sáº£n pháº©m:
```

#### **BÆ°á»›c 3: Chá»n danh má»¥c chi tiáº¿t**
```
âœ… TiÃªu Ä‘á»: [TiÃªu Ä‘á» sáº£n pháº©m]

ðŸ“‚ BÆ°á»›c 2/5: Danh má»¥c
ðŸ’¡ Chá»n danh má»¥c phÃ¹ há»£p vá»›i sáº£n pháº©m

[Danh má»¥c tá»« bÆ°á»›c 1 sáº½ hiá»ƒn thá»‹ cÃ¡c subcategory phÃ¹ há»£p]
```

#### **BÆ°á»›c 4: Nháº­p giÃ¡ bÃ¡n**
```
âœ… Danh má»¥c: [Danh má»¥c Ä‘Ã£ chá»n]

ðŸ’° BÆ°á»›c 3/5: GiÃ¡ bÃ¡n
ðŸ’¡ Nháº­p giÃ¡ bÃ¡n cá»§a sáº£n pháº©m

Vui lÃ²ng nháº­p giÃ¡ (VNÄ):
```

#### **BÆ°á»›c 5: MÃ´ táº£ chi tiáº¿t**
```
âœ… GiÃ¡: [GiÃ¡ Ä‘Ã£ nháº­p]

ðŸ“ BÆ°á»›c 4/5: MÃ´ táº£ sáº£n pháº©m
ðŸ’¡ MÃ´ táº£ chi tiáº¿t vá» sáº£n pháº©m cá»§a báº¡n

Vui lÃ²ng nháº­p mÃ´ táº£ sáº£n pháº©m:
```

#### **BÆ°á»›c 6: Chá»n Ä‘á»‹a Ä‘iá»ƒm**
```
âœ… MÃ´ táº£: [MÃ´ táº£ sáº£n pháº©m]

ðŸ“ BÆ°á»›c 5/5: Äá»‹a Ä‘iá»ƒm
ðŸ’¡ Chá»n nÆ¡i báº¡n Ä‘ang á»Ÿ Ä‘á»ƒ ngÆ°á»i mua dá»… tÃ¬m

[Danh sÃ¡ch tá»‰nh thÃ nh hiá»ƒn thá»‹]
```

#### **BÆ°á»›c 7: HoÃ n thÃ nh Ä‘Äƒng tin**
```
ðŸŽ‰ ÄÄ‚NG TIN THÃ€NH CÃ”NG!

âœ… TiÃªu Ä‘á»: [TiÃªu Ä‘á»]
âœ… Danh má»¥c: [Danh má»¥c]
âœ… GiÃ¡: [GiÃ¡]
âœ… Äá»‹a Ä‘iá»ƒm: [Äá»‹a Ä‘iá»ƒm]

ðŸ“¢ Tin Ä‘Äƒng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t vÃ  hiá»ƒn thá»‹!
ðŸ’¡ NgÆ°á»i mua cÃ³ thá»ƒ liÃªn há»‡ vá»›i báº¡n qua tin nháº¯n.
```

### **ðŸ” QUY TRÃŒNH TÃŒM KIáº¾M**

#### **TÃ¬m kiáº¿m cÆ¡ báº£n**
```
ðŸ” TÃŒM KIáº¾M Sáº¢N PHáº¨M

Báº¡n muá»‘n tÃ¬m gÃ¬?

[ðŸ  Báº¤T Äá»˜NG Sáº¢N] [ðŸš— Ã” TÃ”] [ðŸ“± ÄIá»†N Tá»¬]
[ðŸ‘• THá»œI TRANG] [ðŸ½ï¸ áº¨M THá»°C] [ðŸ”§ Dá»ŠCH Vá»¤]
[ðŸª Táº¤T Cáº¢] [ðŸ” TÃŒM KIáº¾M NÃ‚NG CAO]
```

#### **TÃ¬m kiáº¿m nÃ¢ng cao**
```
ðŸ” TÃŒM KIáº¾M NÃ‚NG CAO

ðŸ’° Khoáº£ng giÃ¡:
[ðŸ’¸ DÆ°á»›i 100 triá»‡u] [ðŸ’° 100-500 triá»‡u] [ðŸ’Ž 500 triá»‡u - 1 tá»·]
[ðŸ† 1-3 tá»·] [â­ 3-5 tá»·] [ðŸŒŸ TrÃªn 5 tá»·]

ðŸ“ Khu vá»±c:
[Danh sÃ¡ch tá»‰nh thÃ nh]

ðŸ·ï¸ Tá»« khÃ³a:
[Ã” tÃ¬m kiáº¿m Ä‘á»ƒ nháº­p tá»« khÃ³a]
```

#### **Káº¿t quáº£ tÃ¬m kiáº¿m**
```
ðŸ  NHÃ€ 3PN, Q7, 100mÂ², view sÃ´ng

ðŸ’° GiÃ¡: 2,500,000,000 VND
ðŸ“ Vá»‹ trÃ­: Quáº­n 7, TP.HCM
â­ Rating: 4.8/5 (15 Ä‘Ã¡nh giÃ¡)
ðŸ‘¤ NgÆ°á»i bÃ¡n: Anh Minh (HÃ  Ná»™i)

[XEM CHI TIáº¾T] [ðŸ’¬ Káº¾T Ná»I] [â¤ï¸ LÆ¯U TIN] [ðŸš« BÃO CÃO]
```

### **ðŸ’¬ QUY TRÃŒNH CHAT Vá»šI ADMIN**

#### **BÆ°á»›c 1: YÃªu cáº§u chat vá»›i admin**
```
ðŸŽ¯ CHá»ŒN CHáº¾ Äá»˜ Sá»¬ Dá»¤NG

ðŸš€ DÃ¹ng bot: Tá»± Ä‘á»™ng mua bÃ¡n vá»›i cá»™ng Ä‘á»“ng
ðŸ’¬ Chat vá»›i admin: Äinh KhÃ¡nh TÃ¹ng há»— trá»£ trá»±c tiáº¿p

[ðŸš€ DÃ™NG BOT] [ðŸ’¬ CHAT Vá»šI ADMIN]
```

#### **BÆ°á»›c 2: ThÃ´ng bÃ¡o admin nháº­n tin nháº¯n**
```
ðŸ’¬ ÄINH KHÃNH TÃ™NG ÄÃƒ NHáº¬N ÄÆ¯á»¢C TIN NHáº®N Cá»¦A Báº N!

â° Admin sáº½ pháº£n há»“i trong thá»i gian sá»›m nháº¥t
ðŸ“ž SÄT: 0982581222 (náº¿u cáº§n gáº¥p)
ðŸ“§ Email: dinhkhanhtung@outlook.com

ðŸ’¡ Báº¡n cÃ³ thá»ƒ:
â€¢ Há»i vá» sáº£n pháº©m
â€¢ YÃªu cáº§u há»— trá»£ ká»¹ thuáº­t
â€¢ BÃ¡o cÃ¡o váº¥n Ä‘á»
â€¢ Äá» xuáº¥t cáº£i tiáº¿n

[ðŸ  Vá»€ MENU CHÃNH] [â“ TRá»¢ GIÃšP]
```

#### **BÆ°á»›c 3: Admin tiáº¿p quáº£n chat**
```
ðŸ”§ ADMIN DASHBOARD

ðŸ’¬ CHAT Má»šI: [TÃªn user] - [Váº¥n Ä‘á»]

[ðŸ’¬ PHáº¢N Há»’I] [ðŸ  Vá»€ DASHBOARD] [ðŸ“Š THá»NG KÃŠ]
```

### **ðŸ”§ QUY TRÃŒNH ADMIN DASHBOARD**

#### **1. Thanh toÃ¡n chá» duyá»‡t**
```
ðŸ’° THANH TOÃN CHá»œ DUYá»†T

1ï¸âƒ£ Anh Minh - 9,000Ä‘ - 15/01/2024 14:30
   ðŸ“¸ BiÃªn lai: [HÃŒNH áº¢NH]
   [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ‘€ XEM CHI TIáº¾T]

2ï¸âƒ£ Chá»‹ Lan - 9,000Ä‘ - 15/01/2024 15:45
   ðŸ“¸ BiÃªn lai: [HÃŒNH áº¢NH]
   [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ‘€ XEM CHI TIáº¾T]

[ðŸ“Š XEM Táº¤T Cáº¢] [ðŸ”„ LÃ€M Má»šI] [ðŸ“¥ XUáº¤T EXCEL]
```

#### **2. Quáº£n lÃ½ ngÆ°á»i dÃ¹ng**
```
ðŸ‘¥ QUáº¢N LÃ NGÆ¯á»œI DÃ™NG

ðŸ” TÃ¬m kiáº¿m: [SEARCH BOX]

ðŸ‘¤ NGÆ¯á»œI DÃ™NG Má»šI:
â€¢ Anh Minh - HÃ  Ná»™i - 15/01/2024
â€¢ Chá»‹ Lan - TP.HCM - 15/01/2024

ðŸ“Š THá»NG KÃŠ:
â€¢ Tá»•ng users: 1,247
â€¢ Active: 892 (71.5%)
â€¢ Trial: 355 (28.5%)
â€¢ Premium: 537 (43%)

[ðŸ‘¤ CHI TIáº¾T] [ðŸ“Š XUáº¤T EXCEL] [ðŸ” Lá»ŒC] [âš™ï¸ Cáº¤U HÃŒNH]
```

#### **3. Quáº£n lÃ½ tin Ä‘Äƒng**
```
ðŸ›’ QUáº¢N LÃ TIN ÄÄ‚NG

ðŸ“Š HÃ”M NAY: 8 tin má»›i

ðŸ  Báº¤T Äá»˜NG Sáº¢N (5)
â€¢ NhÃ  3PN, Q7, 100mÂ² - 2.5 tá»·
â€¢ Chung cÆ° Q1, 80mÂ² - 1.8 tá»·

ðŸš— Ã” TÃ” (2)
â€¢ Toyota Camry 2020 - 800 triá»‡u
â€¢ Honda Civic 2019 - 600 triá»‡u

ðŸ“± ÄIá»†N Tá»¬ (1)
â€¢ iPhone 14 Pro Max - 25 triá»‡u

[ðŸ‘€ XEM CHI TIáº¾T] [âœ… DUYá»†T] [âŒ Tá»ª CHá»I] [ðŸ“Š THá»NG KÃŠ]
```

#### **4. Thá»‘ng kÃª tá»•ng quan**
```
ðŸ“Š THá»NG KÃŠ DASHBOARD

ðŸ“… HÃ”M NAY:
â€¢ Users má»›i: 15 ngÆ°á»i
â€¢ Doanh thu: 150,000Ä‘
â€¢ Tin Ä‘Äƒng: 8 tin
â€¢ Thanh toÃ¡n chá» duyá»‡t: 3

ðŸ“ˆ TUáº¦N NÃ€Y:
â€¢ Users má»›i: 85 ngÆ°á»i
â€¢ Doanh thu: 1,050,000Ä‘
â€¢ Tin Ä‘Äƒng: 42 tin
â€¢ Tá»· lá»‡ chuyá»ƒn Ä‘á»•i: 18.5%

[ðŸ“Š CHI TIáº¾T] [ðŸ“ˆ XU HÆ¯á»šNG] [ðŸ“¥ XUáº¤T BÃO CÃO]
```

### **ðŸ”® QUY TRÃŒNH Tá»¬ VI HÃ€NG NGÃ€Y**

#### **Tá»­ vi TÃ¢n Dáº­u**
```
ðŸ”® Tá»¬ VI TÃ‚N Dáº¬U HÃ”M NAY

ðŸ“… Thá»© 2, 15/01/2024
ðŸ“ Tuá»•i: TÃ¢n Dáº­u (1981)
â­ Tá»•ng quan: 4/5 sao

ðŸ’° TÃ i lá»™c: Ráº¥t tá»‘t - NÃªn Ä‘áº§u tÆ° BÄS
â¤ï¸ TÃ¬nh cáº£m: Tá»‘t - Gáº·p gá»¡ báº¡n bÃ¨
ðŸ¥ Sá»©c khá»e: BÃ¬nh thÆ°á»ng - Nghá»‰ ngÆ¡i
ðŸŽ¯ Sá»± nghiá»‡p: Tá»‘t - CÆ¡ há»™i thÄƒng tiáº¿n

ðŸŽ¯ Lá»i khuyÃªn: HÃ´m nay nÃªn kÃ½ káº¿t há»£p Ä‘á»“ng
ðŸŽ¨ MÃ u may máº¯n: VÃ ng, Tráº¯ng
ðŸ”¢ Sá»‘ may máº¯n: 1, 6, 8

[ðŸŽ² XEM CHI TIáº¾T] [ðŸ“… XEM TUáº¦N] [ðŸ”® XEM THÃNG]
```

### **ðŸ† QUY TRÃŒNH TOP SELLERS**

#### **Báº£ng xáº¿p háº¡ng hÃ ng tuáº§n**
```
ðŸ† TOP SELLER TUáº¦N NÃ€Y

ðŸ¥‡ Anh Minh (HÃ  Ná»™i) - 4.9â­
   â€¢ 15 giao dá»‹ch | 2.5M doanh thu
   â€¢ ChuyÃªn: Báº¥t Ä‘á»™ng sáº£n
   â€¢ Badge: "SiÃªu sao bÃ¡n hÃ ng"

ðŸ¥ˆ Chá»‹ Lan (TP.HCM) - 4.8â­
   â€¢ 12 giao dá»‹ch | 1.8M doanh thu
   â€¢ ChuyÃªn: Ã” tÃ´
   â€¢ Badge: "ChuyÃªn gia Ã´ tÃ´"

ðŸ¥‰ Anh Tuáº¥n (ÄÃ  Náºµng) - 4.7â­
   â€¢ 10 giao dá»‹ch | 1.2M doanh thu
   â€¢ ChuyÃªn: Äiá»‡n tá»­
   â€¢ Badge: "ChuyÃªn gia cÃ´ng nghá»‡"

[ðŸ‘€ XEM CHI TIáº¾T] [ðŸ’¬ Káº¾T Ná»I] [ðŸ“Š XEM Táº¤T Cáº¢]
```

### **ðŸŽ‚ QUY TRÃŒNH THÃ”NG BÃO SINH NHáº¬T**

#### **ThÃ´ng bÃ¡o hÃ ng ngÃ y**
```
ðŸŽ‚ SINH NHáº¬T HÃ”M NAY

ðŸ¥³ ChÃºc má»«ng sinh nháº­t:

â€¢ Anh Minh (HÃ  Ná»™i) - 42 tuá»•i
  ðŸŽ ChÃºc anh sinh nháº­t vui váº»!

â€¢ Chá»‹ Lan (TP.HCM) - 42 tuá»•i
  ðŸŽ ChÃºc chá»‹ sinh nháº­t vui váº»!

â€¢ Anh Tuáº¥n (ÄÃ  Náºµng) - 42 tuá»•i
  ðŸŽ ChÃºc anh sinh nháº­t vui váº»!

[ðŸŽ Gá»¬I Lá»œI CHÃšC] [ðŸ‘¥ XEM Táº¤T Cáº¢] [ðŸ“… Lá»ŠCH SINH NHáº¬T]
```

---

## ðŸ”§ **CHI TIáº¾T Ká»¸ THUáº¬T**

### **ðŸ—ï¸ KIáº¾N TRÃšC FLOW SYSTEM**

#### **1. Unified Entry Point**
```
src/lib/core/unified-entry-point.ts

ðŸŽ¯ Chá»©c nÄƒng:
âœ… Kiá»ƒm tra tráº¡ng thÃ¡i bot
âœ… Kiá»ƒm tra admin takeover
âœ… Quáº£n lÃ½ user mode (choosing/using_bot/chatting_admin)
âœ… Äiá»u phá»‘i Ä‘áº¿n flow phÃ¹ há»£p
âœ… Xá»­ lÃ½ lá»—i táº­p trung
```

#### **2. User Mode Service**
```
src/lib/core/user-mode-service.ts

ðŸŽ¯ Chá»©c nÄƒng:
âœ… Quáº£n lÃ½ tráº¡ng thÃ¡i user (3 cháº¿ Ä‘á»™)
âœ… Gá»­i menu chá»n cháº¿ Ä‘á»™
âœ… Xá»­ lÃ½ chuyá»ƒn Ä‘á»•i cháº¿ Ä‘á»™
âœ… Theo dÃµi sá»‘ láº§n chuyá»ƒn mode
```

#### **3. Smart Menu Service**
```
src/lib/core/smart-menu-service.ts

ðŸŽ¯ Chá»©c nÄƒng:
âœ… Menu Ä‘á»™ng theo ngá»¯ cáº£nh
âœ… 3 loáº¡i menu chÃ­nh
âœ… Tá»‘i Æ°u UX vá»›i menu phÃ¹ há»£p
âœ… Quáº£n lÃ½ payload vÃ  mÃ´ táº£
```

#### **4. Flow Manager**
```
src/lib/core/flow-manager.ts

ðŸŽ¯ Chá»©c nÄƒng:
âœ… Äiá»u phá»‘i message Ä‘áº¿n flow phÃ¹ há»£p
âœ… Quáº£n lÃ½ lifecycle cá»§a flow
âœ… Há»‡ thá»‘ng priority cho flow
âœ… Fallback khi khÃ´ng tÃ¬m Ä‘Æ°á»£c flow
```

#### **5. Session Manager**
```
src/lib/core/session-manager.ts

ðŸŽ¯ Chá»©c nÄƒng:
âœ… Quáº£n lÃ½ session ngÆ°á»i dÃ¹ng
âœ… LÆ°u trá»¯ dá»¯ liá»‡u táº¡m thá»i
âœ… Timeout tá»± Ä‘á»™ng
âœ… Cleanup session cÅ©
```

### **ðŸ¤– FLOW SYSTEM CHI TIáº¾T**

#### **Registration Flow (4 bÆ°á»›c)**
```
BÆ°á»›c 1: Nháº­p há» tÃªn
BÆ°á»›c 2: Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i
BÆ°á»›c 3: Chá»n tá»‰nh/thÃ nh (63 tá»‰nh)
BÆ°á»›c 4: XÃ¡c nháº­n sinh nÄƒm 1981

âœ… Validation Ä‘áº§y Ä‘á»§
âœ… Session management
âœ… Error handling
âœ… Database integration
```

#### **Listing Flow (5 bÆ°á»›c)**
```
BÆ°á»›c 1: Nháº­p tiÃªu Ä‘á»
BÆ°á»›c 2: Chá»n danh má»¥c (11 danh má»¥c chÃ­nh)
BÆ°á»›c 3: Nháº­p giÃ¡ bÃ¡n
BÆ°á»›c 4: Nháº­p mÃ´ táº£
BÆ°á»›c 5: Chá»n Ä‘á»‹a Ä‘iá»ƒm

âœ… Category hierarchy
âœ… Price validation
âœ… Location selection
âœ… Database persistence
```

#### **Search Flow**
```
âœ… Simple search (keyword matching)
âœ… Advanced search (price, location, category)
âœ… Hashtag support
âœ… Relevance scoring
âœ… Result pagination
```

### **ðŸ›¡ï¸ ANTI-SPAM SYSTEM**

#### **1. Spam Tracking Table**
```sql
CREATE TABLE spam_tracking (
    user_id TEXT PRIMARY KEY,
    message_count INTEGER DEFAULT 0,
    last_message_time TIMESTAMPTZ DEFAULT NOW(),
    warning_count INTEGER DEFAULT 0,
    locked_until TIMESTAMPTZ NULL,
    current_flow TEXT NULL
);
```

#### **2. Spam Detection Logic**
```
âœ… Rate limiting (sá»‘ tin nháº¯n/giá»)
âœ… Duplicate message detection
âœ… Suspicious pattern recognition
âœ… Auto-lock vi pháº¡m nghiÃªm trá»ng
âœ… Admin notification
```

#### **3. Spam Actions**
```
âš ï¸ Cáº£nh bÃ¡o: Láº§n Ä‘áº§u vi pháº¡m
â¸ï¸ Táº¡m khÃ³a: Vi pháº¡m nhiá»u láº§n
ðŸš« KhÃ³a vÄ©nh viá»…n: Spam nghiÃªm trá»ng
ðŸ“¢ ThÃ´ng bÃ¡o admin: Tá»± Ä‘á»™ng
```

### **ðŸ’¬ ADMIN TAKEOVER SYSTEM**

#### **1. Admin Takeover States**
```sql
CREATE TABLE admin_takeover_states (
    id UUID PRIMARY KEY,
    user_facebook_id VARCHAR(255) UNIQUE NOT NULL,
    admin_id VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT FALSE,
    started_at TIMESTAMP DEFAULT NOW(),
    ended_at TIMESTAMP
);
```

#### **2. Takeover Process**
```
1ï¸âƒ£ User yÃªu cáº§u chat vá»›i admin
2ï¸âƒ£ Bot gá»­i thÃ´ng bÃ¡o cho admin
3ï¸âƒ£ Admin nháº­n thÃ´ng bÃ¡o qua dashboard
4ï¸âƒ£ Admin tiáº¿p quáº£n cuá»™c trÃ² chuyá»‡n
5ï¸âƒ£ Bot áº©n vÃ  khÃ´ng can thiá»‡p
6ï¸âƒ£ Admin hoÃ n thÃ nh há»— trá»£
7ï¸âƒ£ Admin tráº£ quyá»n Ä‘iá»u khiá»ƒn cho bot
```

### **ðŸ“Š UTILITY HANDLERS**

#### **1. Special Keywords**
```
ðŸ’¡ Help Keywords:
â€¢ help, trá»£ giÃºp, há»— trá»£, hÆ°á»›ng dáº«n

ðŸ‘‹ Greeting Keywords:
â€¢ hello, hi, xin chÃ o, chÃ o

â„¹ï¸ Info Keywords:
â€¢ info, thÃ´ng tin, about, giá»›i thiá»‡u
```

#### **2. Smart Responses**
```
âœ… Help: Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n sá»­ dá»¥ng
âœ… Greeting: ChÃ o há»i thÃ¢n thiá»‡n
âœ… Info: ThÃ´ng tin vá» bot vÃ  cá»™ng Ä‘á»“ng
âœ… Unknown: Gá»£i Ã½ quay láº¡i menu chÃ­nh
```

### **ðŸŽ¯ CONSTANTS & CONFIGURATION**

#### **1. Categories (11 danh má»¥c chÃ­nh)**
```
ðŸ¥ Y Táº¾ (18 subcategories)
ðŸ  Báº¤T Äá»˜NG Sáº¢N (4 subcategories)
ðŸš— Ã” TÃ” (4 subcategories)
ðŸ“± ÄIá»†N Tá»¬ (4 subcategories)
ðŸ‘• THá»œI TRANG (4 subcategories)
ðŸ½ï¸ áº¨M THá»°C (4 subcategories)
ðŸ”§ Dá»ŠCH Vá»¤ (18 subcategories)
ðŸ  Äá»’ GIA Dá»¤NG (4 subcategories)
âš½ THá»‚ THAO (4 subcategories)
ðŸ“š SÃCH (4 subcategories)
ðŸ§¸ Äá»’ CHÆ I (4 subcategories)
```

#### **2. Locations (63 tá»‰nh thÃ nh)**
```
ðŸ  HÃ€ Ná»˜I (32 quáº­n huyá»‡n)
ðŸ¢ TP.HCM (24 quáº­n huyá»‡n)
ðŸ–ï¸ ÄÃ€ Náº´NG (8 quáº­n huyá»‡n)
ðŸ­ Háº¢I PHÃ’NG (15 quáº­n huyá»‡n)
ðŸ¢ Cáº¦N THÆ  (9 quáº­n huyá»‡n)
ðŸŒ NÆ¯á»šC NGOÃ€I
```

#### **3. Pricing Configuration**
```
ðŸ’° BOT_DAILY_FEE: 3,000Ä‘/ngÃ y
ðŸ“… BOT_MINIMUM_DAYS: 3 ngÃ y
ðŸŽ BOT_TRIAL_DAYS: 3 ngÃ y
ðŸ’Ž BOT_REFERRAL_REWARD: 10,000Ä‘
ðŸ” BOT_SEARCH_SERVICE_FEE: 5,000Ä‘
```

### **ðŸ”§ DATABASE TRACKING**

#### **1. User Interactions Table**
```sql
CREATE TABLE user_interactions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    welcome_sent BOOLEAN DEFAULT FALSE,
    last_interaction TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_welcome_sent TIMESTAMP WITH TIME ZONE,
    interaction_count INTEGER DEFAULT 0,
    bot_active BOOLEAN DEFAULT TRUE,
    current_mode VARCHAR(20) DEFAULT 'choosing' CHECK (current_mode IN ('choosing', 'using_bot', 'chatting_admin')),
    last_mode_change TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    mode_change_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **2. Bot Sessions Table**
```sql
CREATE TABLE bot_sessions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    current_flow VARCHAR(100) DEFAULT NULL,
    current_step INTEGER DEFAULT 0,
    step INTEGER DEFAULT 0,
    data JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **3. Spam Tracking Table**
```sql
CREATE TABLE spam_tracking (
    user_id TEXT PRIMARY KEY,
    message_count INTEGER DEFAULT 0,
    last_message_time TIMESTAMPTZ DEFAULT NOW(),
    warning_count INTEGER DEFAULT 0,
    locked_until TIMESTAMPTZ NULL,
    current_flow TEXT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### **4. Admin Chat Sessions Table**
```sql
CREATE TABLE admin_chat_sessions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_facebook_id VARCHAR(255) NOT NULL,
    admin_id VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ended_at TIMESTAMP WITH TIME ZONE,
    last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **5. Admin Takeover States Table**
```sql
CREATE TABLE admin_takeover_states (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_facebook_id VARCHAR(255) UNIQUE NOT NULL,
    admin_id VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT FALSE,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ended_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **ðŸ”— CHI TIáº¾T Má»I QUAN Há»† DATABASE**

#### **Primary Relationships**
```
users (1) â”€â”€â”€â”€ (N) listings
   â€¢ Má»™t user cÃ³ thá»ƒ Ä‘Äƒng nhiá»u tin

users (1) â”€â”€â”€â”€ (N) conversations (user1_id)
   â€¢ Má»™t user cÃ³ thá»ƒ báº¯t Ä‘áº§u nhiá»u cuá»™c trÃ² chuyá»‡n

users (1) â”€â”€â”€â”€ (N) conversations (user2_id)
   â€¢ Má»™t user cÃ³ thá»ƒ tham gia nhiá»u cuá»™c trÃ² chuyá»‡n

users (1) â”€â”€â”€â”€ (N) payments
   â€¢ Má»™t user cÃ³ thá»ƒ cÃ³ nhiá»u thanh toÃ¡n

users (1) â”€â”€â”€â”€ (N) notifications
   â€¢ Má»™t user cÃ³ thá»ƒ nháº­n nhiá»u thÃ´ng bÃ¡o

users (1) â”€â”€â”€â”€ (N) ratings (reviewer_id)
   â€¢ Má»™t user cÃ³ thá»ƒ Ä‘Ã¡nh giÃ¡ nhiá»u ngÆ°á»i khÃ¡c

users (1) â”€â”€â”€â”€ (N) ratings (reviewee_id)
   â€¢ Má»™t user cÃ³ thá»ƒ Ä‘Æ°á»£c nhiá»u ngÆ°á»i Ä‘Ã¡nh giÃ¡

users (1) â”€â”€â”€â”€ (1) user_interactions
   â€¢ Má»™t user cÃ³ má»™t báº£n ghi tÆ°Æ¡ng tÃ¡c

users (1) â”€â”€â”€â”€ (N) bot_sessions
   â€¢ Má»™t user cÃ³ thá»ƒ cÃ³ nhiá»u session (nhÆ°ng chá»‰ má»™t active)

users (1) â”€â”€â”€â”€ (N) user_points
   â€¢ Má»™t user cÃ³ má»™t báº£n ghi Ä‘iá»ƒm thÆ°á»Ÿng

users (1) â”€â”€â”€â”€ (N) point_transactions
   â€¢ Má»™t user cÃ³ nhiá»u giao dá»‹ch Ä‘iá»ƒm

users (1) â”€â”€â”€â”€ (N) search_requests
   â€¢ Má»™t user cÃ³ thá»ƒ táº¡o nhiá»u yÃªu cáº§u tÃ¬m kiáº¿m

users (1) â”€â”€â”€â”€ (N) referrals (referrer_id)
   â€¢ Má»™t user cÃ³ thá»ƒ giá»›i thiá»‡u nhiá»u ngÆ°á»i

users (1) â”€â”€â”€â”€ (N) referrals (referred_id)
   â€¢ Má»™t user cÃ³ thá»ƒ Ä‘Æ°á»£c nhiá»u ngÆ°á»i giá»›i thiá»‡u

users (1) â”€â”€â”€â”€ (N) ads
   â€¢ Má»™t user cÃ³ thá»ƒ táº¡o nhiá»u quáº£ng cÃ¡o

users (1) â”€â”€â”€â”€ (N) events (organizer_id)
   â€¢ Má»™t user cÃ³ thá»ƒ tá»• chá»©c nhiá»u sá»± kiá»‡n

users (1) â”€â”€â”€â”€ (N) event_participants
   â€¢ Má»™t user cÃ³ thá»ƒ tham gia nhiá»u sá»± kiá»‡n
```

#### **Secondary Relationships**
```
conversations (1) â”€â”€â”€â”€ (N) messages
   â€¢ Má»™t cuá»™c trÃ² chuyá»‡n cÃ³ nhiá»u tin nháº¯n

listings (1) â”€â”€â”€â”€ (N) conversations
   â€¢ Má»™t tin Ä‘Äƒng cÃ³ thá»ƒ cÃ³ nhiá»u cuá»™c trÃ² chuyá»‡n

listings (1) â”€â”€â”€â”€ (N) ads
   â€¢ Má»™t tin Ä‘Äƒng cÃ³ thá»ƒ cÃ³ nhiá»u quáº£ng cÃ¡o

users (1) â”€â”€â”€â”€ (N) admin_chat_sessions (user_facebook_id)
   â€¢ Má»™t user cÃ³ thá»ƒ cÃ³ nhiá»u session chat vá»›i admin

users (1) â”€â”€â”€â”€ (N) admin_takeover_states
   â€¢ Má»™t user cÃ³ thá»ƒ bá»‹ admin tiáº¿p quáº£n nhiá»u láº§n
```

### **ðŸ“Š CHI TIáº¾T Cáº¤U TRÃšC Báº¢NG**

#### **Complete Users Table**
```sql
CREATE TABLE users (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    location VARCHAR(100) NOT NULL,
    birthday INTEGER NOT NULL CHECK (birthday = 1981),
    product_service TEXT,
    status VARCHAR(20) DEFAULT 'trial' CHECK (status IN ('trial', 'active', 'expired', 'suspended', 'pending')),
    membership_expires_at TIMESTAMP WITH TIME ZONE,
    rating DECIMAL(3,2) DEFAULT 0.00,
    total_transactions INTEGER DEFAULT 0,
    achievements TEXT[] DEFAULT '{}',
    referral_code VARCHAR(20) UNIQUE NOT NULL,
    avatar_url TEXT,
    email VARCHAR(255),
    bio TEXT,
    website TEXT,
    social_links JSONB DEFAULT '{}',
    is_online BOOLEAN DEFAULT FALSE,
    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    welcome_message_sent BOOLEAN DEFAULT FALSE,
    welcome_interaction_count INTEGER DEFAULT 0,
    chat_mode VARCHAR(20) DEFAULT 'bot' CHECK (chat_mode IN ('bot', 'admin')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Listings Table**
```sql
CREATE TABLE listings (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL CHECK (type IN ('product', 'service')),
    category VARCHAR(100) NOT NULL,
    subcategory VARCHAR(100) NOT NULL,
    title VARCHAR(500) NOT NULL,
    price BIGINT NOT NULL,
    description TEXT NOT NULL,
    images TEXT[] DEFAULT '{}',
    location VARCHAR(200) NOT NULL,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'sold', 'pending')),
    is_featured BOOLEAN DEFAULT FALSE,
    views INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Conversations Table**
```sql
CREATE TABLE conversations (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user1_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    user2_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    listing_id UUID REFERENCES listings(id) ON DELETE SET NULL,
    last_message_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user1_id, user2_id, listing_id)
);
```

#### **Complete Messages Table**
```sql
CREATE TABLE messages (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    message_type VARCHAR(20) DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'file')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Payments Table**
```sql
CREATE TABLE payments (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    amount BIGINT NOT NULL,
    receipt_image TEXT,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    approved_at TIMESTAMP WITH TIME ZONE
);
```

#### **Complete Notifications Table**
```sql
CREATE TABLE notifications (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL CHECK (type IN ('listing', 'message', 'birthday', 'horoscope', 'payment', 'event', 'ai_suggestion', 'security')),
    title VARCHAR(500) NOT NULL,
    message TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Ads Table**
```sql
CREATE TABLE ads (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    listing_id UUID REFERENCES listings(id) ON DELETE CASCADE,
    ad_type VARCHAR(50) NOT NULL CHECK (ad_type IN ('homepage_banner', 'search_boost', 'cross_sell_spot', 'featured_listing')),
    title VARCHAR(500) NOT NULL,
    description TEXT NOT NULL,
    image TEXT,
    budget BIGINT NOT NULL,
    daily_budget BIGINT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'paused', 'completed', 'rejected')),
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    priority INTEGER DEFAULT 1,
    target_category VARCHAR(100),
    target_location VARCHAR(200),
    impressions INTEGER DEFAULT 0,
    clicks INTEGER DEFAULT 0,
    conversions INTEGER DEFAULT 0,
    ctr DECIMAL(5,2) DEFAULT 0.00,
    cpc DECIMAL(10,2) DEFAULT 0.00,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Events Table**
```sql
CREATE TABLE events (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    description TEXT NOT NULL,
    event_date TIMESTAMP WITH TIME ZONE NOT NULL,
    location VARCHAR(500) NOT NULL,
    organizer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'upcoming' CHECK (status IN ('upcoming', 'ongoing', 'completed', 'cancelled')),
    max_participants INTEGER,
    current_participants INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Event Participants Table**
```sql
CREATE TABLE event_participants (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    event_id UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(event_id, user_id)
);
```

#### **Complete Ratings Table**
```sql
CREATE TABLE ratings (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    reviewer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    reviewee_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(reviewer_id, reviewee_id)
);
```

#### **Complete Search Requests Table**
```sql
CREATE TABLE search_requests (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    search_query TEXT NOT NULL,
    category VARCHAR(100) NOT NULL,
    location VARCHAR(200) NOT NULL,
    budget_range VARCHAR(100) NOT NULL,
    priority VARCHAR(20) DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'cancelled')),
    price BIGINT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);
```

#### **Complete Referrals Table**
```sql
CREATE TABLE referrals (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    referrer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    referred_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'cancelled')),
    reward_amount BIGINT NOT NULL,
    reward_paid BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(referrer_id, referred_id)
);
```

#### **Complete User Points Table**
```sql
CREATE TABLE user_points (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    points INTEGER NOT NULL DEFAULT 0,
    level VARCHAR(20) DEFAULT 'Äá»“ng' CHECK (level IN ('Äá»“ng', 'Báº¡c', 'VÃ ng', 'Báº¡ch kim')),
    streak_days INTEGER DEFAULT 0,
    last_activity_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Point Transactions Table**
```sql
CREATE TABLE point_transactions (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    points INTEGER NOT NULL,
    reason VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Admin Users Table**
```sql
CREATE TABLE admin_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE,
    role VARCHAR(50) DEFAULT 'admin' CHECK (role IN ('admin', 'super_admin')),
    permissions JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Bot Settings Table**
```sql
CREATE TABLE bot_settings (
    id SERIAL PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete User Messages Table (Anti-spam)**
```sql
CREATE TABLE user_messages (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    message_id VARCHAR(255) UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Spam Logs Table**
```sql
CREATE TABLE spam_logs (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    reason TEXT NOT NULL,
    blocked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    action VARCHAR(50) NOT NULL DEFAULT 'blocked',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete Chat Bot Offer Counts Table**
```sql
CREATE TABLE chat_bot_offer_counts (
    id BIGSERIAL PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    count INTEGER DEFAULT 1 NOT NULL,
    last_offer TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### **Complete User Bot Modes Table**
```sql
CREATE TABLE user_bot_modes (
    id BIGSERIAL PRIMARY KEY,
    facebook_id VARCHAR(255) UNIQUE NOT NULL,
    in_bot BOOLEAN DEFAULT FALSE NOT NULL,
    entered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);
```

#### **Complete AI Templates Table**
```sql
CREATE TABLE ai_templates (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    admin_id VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    prompt TEXT NOT NULL,
    tone VARCHAR(20) NOT NULL CHECK (tone IN ('friendly', 'professional', 'casual')),
    context VARCHAR(20) NOT NULL CHECK (context IN ('user_type', 'situation', 'goal')),
    category VARCHAR(100) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete AI Analytics Table**
```sql
CREATE TABLE ai_analytics (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    admin_id VARCHAR(255) NOT NULL,
    template_id UUID REFERENCES ai_templates(id) ON DELETE SET NULL,
    prompt TEXT NOT NULL,
    response TEXT NOT NULL,
    tone VARCHAR(20) NOT NULL,
    context VARCHAR(20) NOT NULL,
    model_used VARCHAR(50) NOT NULL,
    tokens_used INTEGER NOT NULL,
    response_time INTEGER NOT NULL,
    success BOOLEAN NOT NULL,
    error_message TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### **Complete System Metrics Table**
```sql
CREATE TABLE system_metrics (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    date DATE NOT NULL,
    total_pending_users INTEGER DEFAULT 0,
    pending_users_today INTEGER DEFAULT 0,
    total_searches_today INTEGER DEFAULT 0,
    total_messages_today INTEGER DEFAULT 0,
    average_response_time_ms INTEGER DEFAULT 0,
    error_rate_percentage DECIMAL(5,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(date)
);
```

#### **Complete User Activities Table**
```sql
CREATE TABLE user_activities (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    facebook_id TEXT NOT NULL,
    date DATE NOT NULL,
    listings_count INTEGER DEFAULT 0,
    searches_count INTEGER DEFAULT 0,
    messages_count INTEGER DEFAULT 0,
    admin_chat_count INTEGER DEFAULT 0,
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(facebook_id, date)
);
```

#### **Complete User Activity Logs Table**
```sql
CREATE TABLE user_activity_logs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    facebook_id TEXT NOT NULL,
    user_type TEXT NOT NULL,
    action TEXT NOT NULL,
    details JSONB,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    success BOOLEAN DEFAULT true,
    error_message TEXT,
    response_time_ms INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **ðŸ” INDEXES VÃ€ PERFORMANCE OPTIMIZATION**

#### **Users Table Indexes**
```sql
CREATE INDEX idx_users_facebook_id ON users(facebook_id);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_referral_code ON users(referral_code);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_welcome_message_sent ON users(welcome_message_sent);
CREATE INDEX idx_users_status_created_at ON users(status, created_at DESC);
CREATE INDEX idx_users_membership_expires ON users(membership_expires_at) WHERE membership_expires_at IS NOT NULL;
```

#### **Listings Table Indexes**
```sql
CREATE INDEX idx_listings_user_id ON listings(user_id);
CREATE INDEX idx_listings_category ON listings(category);
CREATE INDEX idx_listings_status ON listings(status);
CREATE INDEX idx_listings_status_category ON listings(status, category);
CREATE INDEX idx_listings_user_status ON listings(user_id, status);
CREATE INDEX idx_listings_featured ON listings(is_featured) WHERE is_featured = true;
```

#### **Conversations Table Indexes**
```sql
CREATE INDEX idx_conversations_user1_id ON conversations(user1_id);
CREATE INDEX idx_conversations_user2_id ON conversations(user2_id);
CREATE INDEX idx_conversations_last_message ON conversations(last_message_at DESC);
```

#### **Messages Table Indexes**
```sql
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_messages_conversation_created ON messages(conversation_id, created_at ASC);
```

#### **Payments Table Indexes**
```sql
CREATE INDEX idx_payments_status_created_at ON payments(status, created_at DESC);
CREATE INDEX idx_payments_user_status ON payments(user_id, status);
```

#### **Notifications Table Indexes**
```sql
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read, created_at DESC);
```

#### **Ads Table Indexes**
```sql
CREATE INDEX idx_ads_status_dates ON ads(status, start_date, end_date);
```

#### **User Interactions Indexes**
```sql
CREATE INDEX idx_user_interactions_facebook_id ON user_interactions(facebook_id);
CREATE INDEX idx_user_interactions_bot_active ON user_interactions(bot_active);
CREATE INDEX idx_user_interactions_current_mode ON user_interactions(current_mode);
CREATE INDEX idx_user_interactions_last_mode_change ON user_interactions(last_mode_change);
CREATE INDEX idx_user_interactions_last_welcome_sent ON user_interactions(last_welcome_sent) WHERE last_welcome_sent IS NOT NULL;
```

#### **Bot Sessions Indexes**
```sql
CREATE INDEX idx_bot_sessions_facebook_id ON bot_sessions(facebook_id);
CREATE INDEX idx_bot_sessions_current_flow ON bot_sessions(current_flow) WHERE current_flow IS NOT NULL;
```

#### **Admin Chat Sessions Indexes**
```sql
CREATE INDEX idx_admin_chat_sessions_user_facebook_id ON admin_chat_sessions(user_facebook_id);
CREATE INDEX idx_admin_chat_sessions_is_active ON admin_chat_sessions(is_active);
CREATE INDEX idx_admin_chat_sessions_admin_id ON admin_chat_sessions(admin_id);
```

#### **User Activities Indexes**
```sql
CREATE INDEX idx_user_activities_facebook_date ON user_activities(facebook_id, date);
CREATE INDEX idx_user_activities_date ON user_activities(date);
CREATE INDEX idx_user_activities_last_activity ON user_activities(last_activity);
```

#### **User Activity Logs Indexes**
```sql
CREATE INDEX idx_user_activity_logs_facebook_id ON user_activity_logs(facebook_id);
CREATE INDEX idx_user_activity_logs_timestamp ON user_activity_logs(timestamp);
CREATE INDEX idx_user_activity_logs_user_type ON user_activity_logs(user_type);
CREATE INDEX idx_user_activity_logs_action ON user_activity_logs(action);
CREATE INDEX idx_user_activity_logs_success ON user_activity_logs(success);
```

#### **System Metrics Indexes**
```sql
CREATE INDEX idx_system_metrics_date ON system_metrics(date);
```

#### **Spam Tracking Indexes**
```sql
CREATE INDEX idx_spam_tracking_user_id ON spam_tracking(user_id);
CREATE INDEX idx_spam_tracking_locked_until ON spam_tracking(locked_until) WHERE locked_until IS NOT NULL;
CREATE INDEX idx_spam_tracking_last_message ON spam_tracking(last_message_time);
```

#### **AI Tables Indexes**
```sql
CREATE INDEX idx_ai_templates_admin_id ON ai_templates(admin_id);
CREATE INDEX idx_ai_templates_category ON ai_templates(category);
CREATE INDEX idx_ai_templates_is_active ON ai_templates(is_active);

CREATE INDEX idx_ai_analytics_admin_id ON ai_analytics(admin_id);
CREATE INDEX idx_ai_analytics_template_id ON ai_analytics(template_id);
CREATE INDEX idx_ai_analytics_created_at ON ai_analytics(created_at);
CREATE INDEX idx_ai_analytics_model_used ON ai_analytics(model_used);
CREATE INDEX idx_ai_analytics_success ON ai_analytics(success);
```

### **âš¡ TRIGGERS VÃ€ FUNCTIONS**

#### **Updated_at Trigger Function**
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

#### **Triggers cho táº¥t cáº£ báº£ng**
```sql
-- Users
DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Listings
DROP TRIGGER IF EXISTS update_listings_updated_at ON listings;
CREATE TRIGGER update_listings_updated_at BEFORE UPDATE ON listings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Admin Chat Sessions
DROP TRIGGER IF EXISTS update_admin_chat_sessions_updated_at ON admin_chat_sessions;
CREATE TRIGGER update_admin_chat_sessions_updated_at BEFORE UPDATE ON admin_chat_sessions
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- VÃ  nhiá»u triggers khÃ¡c cho cÃ¡c báº£ng cÃ²n láº¡i...
```

#### **Utility Functions**
```sql
-- Function to get daily system metrics summary
CREATE OR REPLACE FUNCTION get_daily_metrics_summary(target_date DATE DEFAULT CURRENT_DATE)
RETURNS TABLE (
    total_pending_users BIGINT,
    pending_users_today BIGINT,
    total_searches_today BIGINT,
    total_messages_today BIGINT,
    average_response_time_ms NUMERIC,
    error_rate_percentage NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        (SELECT COUNT(*) FROM users WHERE status = 'pending')::BIGINT as total_pending_users,
        (SELECT COUNT(*) FROM users WHERE status = 'pending' AND DATE(created_at) = target_date)::BIGINT as pending_users_today,
        (SELECT COALESCE(SUM(searches_count), 0) FROM user_activities WHERE date = target_date)::BIGINT as total_searches_today,
        (SELECT COALESCE(SUM(messages_count), 0) FROM user_activities WHERE date = target_date)::BIGINT as total_messages_today,
        (SELECT COALESCE(AVG(response_time_ms), 0) FROM user_activity_logs WHERE DATE(timestamp) = target_date AND success = true)::NUMERIC as average_response_time_ms,
        (SELECT COALESCE(
            (COUNT(*) FILTER (WHERE success = false)::NUMERIC / COUNT(*)::NUMERIC) * 100,
            0
        ) FROM user_activity_logs WHERE DATE(timestamp) = target_date)::NUMERIC as error_rate_percentage;
END;
$$ language 'plpgsql';

-- Function to get user engagement score
CREATE OR REPLACE FUNCTION get_user_engagement_score(user_facebook_id TEXT)
RETURNS INTEGER AS $$
DECLARE
    score INTEGER := 0;
    user_record RECORD;
    activity_record RECORD;
BEGIN
    -- Base score from user status
    SELECT * INTO user_record FROM users WHERE facebook_id = user_facebook_id;

    IF user_record.status = 'active' THEN
        score := score + 50;
    ELSIF user_record.status = 'trial' THEN
        score := score + 25;
    END IF;

    -- Score from recent activity (last 7 days)
    SELECT * INTO activity_record
    FROM user_activities
    WHERE facebook_id = user_facebook_id
    AND date >= CURRENT_DATE - INTERVAL '7 days'
    ORDER BY date DESC
    LIMIT 1;

    IF activity_record.id IS NOT NULL THEN
        score := score + LEAST(activity_record.listings_count * 10, 50);
        score := score + LEAST(activity_record.searches_count * 5, 25);
        score := score + LEAST(activity_record.messages_count * 3, 15);
    END IF;

    -- Score from points
    SELECT COALESCE(points, 0) INTO score FROM user_points
    WHERE user_id = user_record.id;

    RETURN GREATEST(score, 0);
END;
$$ LANGUAGE plpgsql;

-- Function to cleanup old data
CREATE OR REPLACE FUNCTION safe_cleanup_old_data(days_to_keep INTEGER DEFAULT 90)
RETURNS TABLE(
    table_name TEXT,
    deleted_count BIGINT
) AS $$
DECLARE
    cleanup_tables RECORD;
    delete_count BIGINT;
BEGIN
    -- List of tables with their retention policies
    FOR cleanup_tables IN
        SELECT
            t.table_name,
            CASE
                WHEN t.table_name IN ('user_activity_logs', 'system_metrics') THEN days_to_keep
                WHEN t.table_name IN ('spam_logs') THEN 30
                WHEN t.table_name IN ('chat_bot_offer_counts') THEN 7
                ELSE 365
            END as retention_days
        FROM information_schema.tables t
        WHERE t.table_schema = 'public'
        AND t.table_name IN (
            'user_activity_logs', 'system_metrics', 'spam_logs',
            'chat_bot_offer_counts', 'user_messages'
        )
    LOOP
        -- Dynamic SQL to delete old records
        EXECUTE format(
            'DELETE FROM %I WHERE created_at < NOW() - INTERVAL ''%s days''',
            cleanup_tables.table_name,
            cleanup_tables.retention_days
        );

        GET DIAGNOSTICS delete_count = ROW_COUNT;

        table_name := cleanup_tables.table_name;
        deleted_count := delete_count;
        RETURN NEXT;
    END LOOP;

    RETURN;
END;
$$ LANGUAGE plpgsql;
```

### **ðŸ”’ CONSTRAINTS VÃ€ DATA INTEGRITY**

#### **Check Constraints**
```sql
-- Payment amounts must be positive
ALTER TABLE payments ADD CONSTRAINT check_positive_amount CHECK (amount > 0);

-- Listing prices must be positive
ALTER TABLE listings ADD CONSTRAINT check_positive_price CHECK (price > 0);

-- Ad budgets must be positive
ALTER TABLE ads ADD CONSTRAINT check_positive_budget CHECK (budget > 0);

-- Point amounts must be valid
ALTER TABLE point_transactions ADD CONSTRAINT check_valid_points CHECK (points != 0);

-- Rating must be between 1-5
ALTER TABLE ratings ADD CONSTRAINT check_rating_range CHECK (rating >= 1 AND rating <= 5);

-- Birthday must be 1981
ALTER TABLE users ADD CONSTRAINT check_birthday_1981 CHECK (birthday = 1981);

-- Status enums
ALTER TABLE users ADD CONSTRAINT check_user_status CHECK (status IN ('trial', 'active', 'expired', 'suspended', 'pending'));
ALTER TABLE listings ADD CONSTRAINT check_listing_status CHECK (status IN ('active', 'inactive', 'sold', 'pending'));
ALTER TABLE payments ADD CONSTRAINT check_payment_status CHECK (status IN ('pending', 'approved', 'rejected'));
ALTER TABLE ads ADD CONSTRAINT check_ad_status CHECK (status IN ('pending', 'active', 'paused', 'completed', 'rejected'));
ALTER TABLE events ADD CONSTRAINT check_event_status CHECK (status IN ('upcoming', 'ongoing', 'completed', 'cancelled'));
ALTER TABLE search_requests ADD CONSTRAINT check_search_status CHECK (status IN ('pending', 'processing', 'completed', 'cancelled'));
ALTER TABLE referrals ADD CONSTRAINT check_referral_status CHECK (status IN ('pending', 'completed', 'cancelled'));
ALTER TABLE notifications ADD CONSTRAINT check_notification_type CHECK (type IN ('listing', 'message', 'birthday', 'horoscope', 'payment', 'event', 'ai_suggestion', 'security'));
ALTER TABLE ads ADD CONSTRAINT check_ad_type CHECK (ad_type IN ('homepage_banner', 'search_boost', 'cross_sell_spot', 'featured_listing'));
ALTER TABLE user_interactions ADD CONSTRAINT check_current_mode CHECK (current_mode IN ('choosing', 'using_bot', 'chatting_admin'));
ALTER TABLE users ADD CONSTRAINT check_chat_mode CHECK (chat_mode IN ('bot', 'admin'));
ALTER TABLE user_points ADD CONSTRAINT check_user_level CHECK (level IN ('Äá»“ng', 'Báº¡c', 'VÃ ng', 'Báº¡ch kim'));
ALTER TABLE search_requests ADD CONSTRAINT check_priority CHECK (priority IN ('low', 'medium', 'high'));
ALTER TABLE ai_templates ADD CONSTRAINT check_tone CHECK (tone IN ('friendly', 'professional', 'casual'));
ALTER TABLE ai_templates ADD CONSTRAINT check_context CHECK (context IN ('user_type', 'situation', 'goal'));
ALTER TABLE messages ADD CONSTRAINT check_message_type CHECK (message_type IN ('text', 'image', 'file'));
ALTER TABLE admin_users ADD CONSTRAINT check_admin_role CHECK (role IN ('admin', 'super_admin'));
```

#### **Foreign Key Constraints**
```sql
-- Users relationships
ALTER TABLE listings ADD CONSTRAINT fk_listings_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE conversations ADD CONSTRAINT fk_conversations_user1_id FOREIGN KEY (user1_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE conversations ADD CONSTRAINT fk_conversations_user2_id FOREIGN KEY (user2_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE payments ADD CONSTRAINT fk_payments_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE notifications ADD CONSTRAINT fk_notifications_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE ratings ADD CONSTRAINT fk_ratings_reviewer_id FOREIGN KEY (reviewer_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE ratings ADD CONSTRAINT fk_ratings_reviewee_id FOREIGN KEY (reviewee_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE user_interactions ADD CONSTRAINT fk_user_interactions_facebook_id FOREIGN KEY (facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;
ALTER TABLE bot_sessions ADD CONSTRAINT fk_bot_sessions_facebook_id FOREIGN KEY (facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;
ALTER TABLE user_points ADD CONSTRAINT fk_user_points_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE point_transactions ADD CONSTRAINT fk_point_transactions_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE search_requests ADD CONSTRAINT fk_search_requests_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE referrals ADD CONSTRAINT fk_referrals_referrer_id FOREIGN KEY (referrer_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE referrals ADD CONSTRAINT fk_referrals_referred_id FOREIGN KEY (referred_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE ads ADD CONSTRAINT fk_ads_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE events ADD CONSTRAINT fk_events_organizer_id FOREIGN KEY (organizer_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE event_participants ADD CONSTRAINT fk_event_participants_event_id FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE;
ALTER TABLE event_participants ADD CONSTRAINT fk_event_participants_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE admin_chat_sessions ADD CONSTRAINT fk_admin_chat_sessions_user_facebook_id FOREIGN KEY (user_facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;
ALTER TABLE admin_takeover_states ADD CONSTRAINT fk_admin_takeover_states_user_facebook_id FOREIGN KEY (user_facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;

-- Secondary relationships
ALTER TABLE conversations ADD CONSTRAINT fk_conversations_listing_id FOREIGN KEY (listing_id) REFERENCES listings(id) ON DELETE SET NULL;
ALTER TABLE messages ADD CONSTRAINT fk_messages_conversation_id FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE;
ALTER TABLE messages ADD CONSTRAINT fk_messages_sender_id FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE;
ALTER TABLE ads ADD CONSTRAINT fk_ads_listing_id FOREIGN KEY (listing_id) REFERENCES listings(id) ON DELETE CASCADE;
ALTER TABLE ai_analytics ADD CONSTRAINT fk_ai_analytics_template_id FOREIGN KEY (template_id) REFERENCES ai_templates(id) ON DELETE SET NULL;
ALTER TABLE user_activities ADD CONSTRAINT fk_user_activities_facebook_id FOREIGN KEY (facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;
ALTER TABLE user_activity_logs ADD CONSTRAINT fk_user_activity_logs_facebook_id FOREIGN KEY (facebook_id) REFERENCES users(facebook_id) ON DELETE CASCADE;
```

#### **Unique Constraints**
```sql
-- Users
ALTER TABLE users ADD CONSTRAINT unique_users_facebook_id UNIQUE (facebook_id);
ALTER TABLE users ADD CONSTRAINT unique_users_phone UNIQUE (phone);
ALTER TABLE users ADD CONSTRAINT unique_users_referral_code UNIQUE (referral_code);

-- Conversations
ALTER TABLE conversations ADD CONSTRAINT unique_conversations_user1_user2_listing UNIQUE (user1_id, user2_id, listing_id);

-- Referrals
ALTER TABLE referrals ADD CONSTRAINT unique_referrals_referrer_referred UNIQUE (referrer_id, referred_id);

-- User Activities
ALTER TABLE user_activities ADD CONSTRAINT unique_user_activities_facebook_date UNIQUE (facebook_id, date);

-- System Metrics
ALTER TABLE system_metrics ADD CONSTRAINT unique_system_metrics_date UNIQUE (date);

-- Event Participants
ALTER TABLE event_participants ADD CONSTRAINT unique_event_participants_event_user UNIQUE (event_id, user_id);

-- Ratings
ALTER TABLE ratings ADD CONSTRAINT unique_ratings_reviewer_reviewee UNIQUE (reviewer_id, reviewee_id);

-- User Messages
ALTER TABLE user_messages ADD CONSTRAINT unique_user_messages_message_id UNIQUE (message_id);

-- Admin Users
ALTER TABLE admin_users ADD CONSTRAINT unique_admin_users_username UNIQUE (username);
ALTER TABLE admin_users ADD CONSTRAINT unique_admin_users_email UNIQUE (email);

-- Bot Settings
ALTER TABLE bot_settings ADD CONSTRAINT unique_bot_settings_key UNIQUE (key);

-- Chat Bot Offer Counts
ALTER TABLE chat_bot_offer_counts ADD CONSTRAINT unique_chat_bot_offer_counts_facebook_id UNIQUE (facebook_id);

-- User Bot Modes
ALTER TABLE user_bot_modes ADD CONSTRAINT unique_user_bot_modes_facebook_id UNIQUE (facebook_id);

-- AI Templates
-- (KhÃ´ng cÃ³ unique constraints Ä‘áº·c biá»‡t)
```

### **ðŸ“Š VIEWS VÃ€ UTILITY QUERIES**

#### **Active Users Summary View**
```sql
CREATE OR REPLACE VIEW active_users_summary AS
SELECT
    u.id,
    u.facebook_id,
    u.name,
    u.phone,
    u.status,
    u.membership_expires_at,
    u.created_at as user_created_at,
    ua.last_activity,
    ua.listings_count,
    ua.searches_count,
    ua.messages_count,
    COALESCE(up.points, 0) as current_points,
    COALESCE(up.level, 'Äá»“ng') as user_level
FROM users u
LEFT JOIN user_activities ua ON ua.facebook_id = u.facebook_id
    AND ua.date = CURRENT_DATE
LEFT JOIN user_points up ON up.user_id = u.id
WHERE u.status IN ('active', 'trial')
ORDER BY ua.last_activity DESC NULLS LAST;
```

#### **System Health Metrics View**
```sql
CREATE OR REPLACE VIEW system_health_metrics AS
SELECT
    sm.date,
    sm.total_pending_users,
    sm.pending_users_today,
    sm.total_searches_today,
    sm.total_messages_today,
    sm.average_response_time_ms,
    sm.error_rate_percentage,
    COUNT(DISTINCT ual.facebook_id) as active_users_today,
    COUNT(CASE WHEN ual.success = false THEN 1 END) as errors_today
FROM system_metrics sm
LEFT JOIN user_activity_logs ual ON ual.timestamp::date = sm.date
WHERE sm.date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY sm.date, sm.total_pending_users, sm.pending_users_today,
         sm.total_searches_today, sm.total_messages_today,
         sm.average_response_time_ms, sm.error_rate_percentage
ORDER BY sm.date DESC;
```

#### **User Engagement Score Function**
```sql
CREATE OR REPLACE FUNCTION get_user_engagement_score(user_facebook_id TEXT)
RETURNS INTEGER AS $$
DECLARE
    score INTEGER := 0;
    user_record RECORD;
    activity_record RECORD;
BEGIN
    -- Base score from user status
    SELECT * INTO user_record FROM users WHERE facebook_id = user_facebook_id;

    IF user_record.status = 'active' THEN
        score := score + 50;
    ELSIF user_record.status = 'trial' THEN
        score := score + 25;
    END IF;

    -- Score from recent activity (last 7 days)
    SELECT * INTO activity_record
    FROM user_activities
    WHERE facebook_id = user_facebook_id
    AND date >= CURRENT_DATE - INTERVAL '7 days'
    ORDER BY date DESC
    LIMIT 1;

    IF activity_record.id IS NOT NULL THEN
        score := score + LEAST(activity_record.listings_count * 10, 50);
        score := score + LEAST(activity_record.searches_count * 5, 25);
        score := score + LEAST(activity_record.messages_count * 3, 15);
    END IF;

    -- Score from points
    SELECT COALESCE(points, 0) INTO score FROM user_points
    WHERE user_id = user_record.id;

    RETURN GREATEST(score, 0);
END;
$$ LANGUAGE plpgsql;
```

#### **Daily Metrics Summary Function**
```sql
CREATE OR REPLACE FUNCTION get_daily_metrics_summary(target_date DATE DEFAULT CURRENT_DATE)
RETURNS TABLE (
    total_pending_users BIGINT,
    pending_users_today BIGINT,
    total_searches_today BIGINT,
    total_messages_today BIGINT,
    average_response_time_ms NUMERIC,
    error_rate_percentage NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        (SELECT COUNT(*) FROM users WHERE status = 'pending')::BIGINT as total_pending_users,
        (SELECT COUNT(*) FROM users WHERE status = 'pending' AND DATE(created_at) = target_date)::BIGINT as pending_users_today,
        (SELECT COALESCE(SUM(searches_count), 0) FROM user_activities WHERE date = target_date)::BIGINT as total_searches_today,
        (SELECT COALESCE(SUM(messages_count), 0) FROM user_activities WHERE date = target_date)::BIGINT as total_messages_today,
        (SELECT COALESCE(AVG(response_time_ms), 0) FROM user_activity_logs WHERE DATE(timestamp) = target_date AND success = true)::NUMERIC as average_response_time_ms,
        (SELECT COALESCE(
            (COUNT(*) FILTER (WHERE success = false)::NUMERIC / COUNT(*)::NUMERIC) * 100,
            0
        ) FROM user_activity_logs WHERE DATE(timestamp) = target_date)::NUMERIC as error_rate_percentage;
END;
$$ language 'plpgsql';
```

#### **User Activity Summary Function**
```sql
CREATE OR REPLACE FUNCTION get_user_activity_summary(
    target_facebook_id TEXT,
    days_back INTEGER DEFAULT 7
)
RETURNS TABLE (
    total_activities BIGINT,
    success_rate NUMERIC,
    average_response_time_ms NUMERIC,
    action_counts JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*)::BIGINT as total_activities,
        COALESCE(
            (COUNT(*) FILTER (WHERE success = true)::NUMERIC / COUNT(*)::NUMERIC) * 100,
            0
        )::NUMERIC as success_rate,
        COALESCE(AVG(response_time_ms), 0)::NUMERIC as average_response_time_ms,
        jsonb_object_agg(action, action_count) as action_counts
    FROM (
        SELECT
            action,
            COUNT(*) as action_count
        FROM user_activity_logs
        WHERE facebook_id = target_facebook_id
        AND timestamp >= NOW() - INTERVAL '1 day' * days_back
        GROUP BY action
    ) action_stats;
END;
$$ language 'plpgsql';
```

#### **Safe Cleanup Old Data Function**
```sql
CREATE OR REPLACE FUNCTION safe_cleanup_old_data(days_to_keep INTEGER DEFAULT 90)
RETURNS TABLE(
    table_name TEXT,
    deleted_count BIGINT
) AS $$
DECLARE
    cleanup_tables RECORD;
    delete_count BIGINT;
BEGIN
    -- List of tables with their retention policies
    FOR cleanup_tables IN
        SELECT
            t.table_name,
            CASE
                WHEN t.table_name IN ('user_activity_logs', 'system_metrics') THEN days_to_keep
                WHEN t.table_name IN ('spam_logs') THEN 30
                WHEN t.table_name IN ('chat_bot_offer_counts') THEN 7
                ELSE 365
            END as retention_days
        FROM information_schema.tables t
        WHERE t.table_schema = 'public'
        AND t.table_name IN (
            'user_activity_logs', 'system_metrics', 'spam_logs',
            'chat_bot_offer_counts', 'user_messages'
        )
    LOOP
        -- Dynamic SQL to delete old records
        EXECUTE format(
            'DELETE FROM %I WHERE created_at < NOW() - INTERVAL ''%s days''',
            cleanup_tables.table_name,
            cleanup_tables.retention_days
        );

        GET DIAGNOSTICS delete_count = ROW_COUNT;

        table_name := cleanup_tables.table_name;
        deleted_count := delete_count;
        RETURN NEXT;
    END LOOP;

    RETURN;
END;
$$ LANGUAGE plpgsql;
```

#### **Execute SQL Function (Workflow API)**
```sql
CREATE OR REPLACE FUNCTION execute_sql(sql_query TEXT, sql_params TEXT[] DEFAULT '{}')
RETURNS TABLE(
    id TEXT,
    data JSONB
) AS $$
DECLARE
    result RECORD;
    param TEXT;
    i INTEGER := 1;
BEGIN
    -- Replace parameter placeholders with actual values
    FOR param IN SELECT unnest(sql_params) LOOP
        sql_query := REPLACE(sql_query, '$' || i, quote_literal(param));
        i := i + 1;
    END LOOP;

    -- Execute the query and return results
    FOR result IN EXECUTE sql_query LOOP
        id := result.id::TEXT;
        data := row_to_json(result)::JSONB;
        RETURN NEXT;
    END LOOP;

    RETURN;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## ðŸŽ‰ **Káº¾T LUáº¬N**

**ðŸŽ‰ BOT TÃ‚N Dáº¬U - Há»– TRá»¢ CHÃ‰O Ä‘Ã£ sáºµn sÃ ng phá»¥c vá»¥ cá»™ng Ä‘á»“ng vÃ  táº¡o thu nháº­p bá»n vá»¯ng!**

### **ðŸŒŸ Äiá»ƒm máº¡nh cá»§a há»‡ thá»‘ng:**

#### **âœ… HoÃ n thiá»‡n vá» tÃ­nh nÄƒng**
- **18 báº£ng database** vá»›i Ä‘áº§y Ä‘á»§ quan há»‡
- **11 danh má»¥c sáº£n pháº©m** vá»›i subcategory chi tiáº¿t
- **63 tá»‰nh thÃ nh** vá»›i quáº­n huyá»‡n cá»¥ thá»ƒ
- **3 cháº¿ Ä‘á»™ hoáº¡t Ä‘á»™ng** linh hoáº¡t
- **Anti-spam thÃ´ng minh** báº£o vá»‡ há»‡ thá»‘ng

#### **âœ… Tá»‘i Æ°u vá» tráº£i nghiá»‡m**
- **Flow system** xá»­ lÃ½ mÆ°á»£t mÃ 
- **Session management** khÃ´ng máº¥t dá»¯ liá»‡u
- **Smart menu** theo ngá»¯ cáº£nh
- **Error handling** toÃ n diá»‡n
- **Real-time logging** dá»… debug

#### **âœ… Sáºµn sÃ ng má»Ÿ rá»™ng**
- **Modular architecture** dá»… thÃªm tÃ­nh nÄƒng
- **Scalable database** há»— trá»£ 10,000+ users
- **AI-ready structure** cÃ³ thá»ƒ tÃ­ch há»£p AI
- **Multi-platform ready** cÃ³ thá»ƒ phÃ¡t triá»ƒn app

### **ðŸ’° MÃ´ hÃ¬nh kinh doanh bá»n vá»¯ng**
```
ðŸ’³ PhÃ­ dá»‹ch vá»¥: 3,000Ä‘/ngÃ y
ðŸ“… Tá»‘i thiá»ƒu: 3 ngÃ y = 9,000Ä‘
ðŸŽ Trial: 3 ngÃ y miá»…n phÃ­
ðŸ’Ž Referral: 10,000Ä‘ má»—i giá»›i thiá»‡u
ðŸ” Dá»‹ch vá»¥ tÃ¬m kiáº¿m: 5,000Ä‘/láº§n
ðŸ“¢ Quáº£ng cÃ¡o: 15,000-50,000Ä‘/tuáº§n
```

### **ðŸš€ Káº¿ hoáº¡ch phÃ¡t triá»ƒn tiáº¿p theo**
```
ðŸ“ˆ ThÃ¡ng 1-3: Tá»‘i Æ°u vÃ  má»Ÿ rá»™ng tÃ­nh nÄƒng hiá»‡n cÃ³
ðŸ“ˆ ThÃ¡ng 4-6: TÃ­ch há»£p AI chatbot thÃ´ng minh
ðŸ“ˆ ThÃ¡ng 7-9: PhÃ¡t triá»ƒn mobile app
ðŸ“ˆ ThÃ¡ng 10-12: Má»Ÿ rá»™ng cá»™ng Ä‘á»“ng vÃ  tÃ­nh nÄƒng cao cáº¥p
```

**ðŸŒŸ ChÃºc báº¡n thÃ nh cÃ´ng rá»±c rá»¡ vá»›i dá»± Ã¡n tuyá»‡t vá»i nÃ y!**

---

**ðŸ“ TÃ i liá»‡u Ä‘Æ°á»£c táº¡o bá»Ÿi AI Assistant**  
**ðŸ“… Cáº­p nháº­t láº§n cuá»‘i: 10/21/2025**  
**ðŸ”„ Version: 2.2.0 - Complete System Documentation**  
**ðŸ“Š Pages: 15+ pages of detailed documentation**
